# 프로젝트 안내

## 펌웨어 개요
- 대상 보드: STM32H7S 내장 HS PHY, 기본 폴링 8000Hz.
- 전송 속도: HS 4k/2kHz 및 FS 1kHz 지원, HS 우선 정책.
- 핵심 기능: USB instability monitor(마이크로프레임 격차 감시, V250924R4), 단계적 폴링 다운그레이드 큐, QMK 포팅층.

## 작업 전 점검 순서
1. `_DEF_FIRMWATRE_VERSION`과 보드 매크로를 `src/hw/hw_def.h`에서 확인합니다.
2. 엔트리 경로는 `src/main.c → src/ap/ap.c` 흐름을 따라 추적합니다.
3. QMK 구조 파악 시 `src/ap/modules/qmk/{port,keyboards,quantum}`을 우선 검토합니다.
4. 수정 시 `src/ap/modules/qmk/port/sys_port.*`, `src/hw/driver/`을 고위험 파일로 분류해 집중 리뷰합니다.

## 변경 기록 규칙
- 모든 코드 변경에는 `// VYYMMDDRn ...` 형식의 주석을 추가하고, 동일 날짜에 여러 번 수정 시 `Rn`을 증가시킵니다.
- `_DEF_FIRMWATRE_VERSION` 값을 변경했다면 최신 `VYYMMDDRn`과 동기화해야 합니다.

## 코드 스타일
- 들여쓰기는 공백 두 칸, 함수/제어문 중괄호는 새 줄에 배치합니다.
- `if (cond)` 처럼 여는 괄호 전에 공백을 두고, 닫는 괄호 뒤에는 한 칸 후 중괄호를 넣습니다.
- 연산자는 `a + b`처럼 좌우에 공백을 두되, 기존 코드에서 공백이 없는 연속 호출(`millis()-pre_time`)은 주변 컨벤션을 유지합니다.
- `#define`은 상수명을 모두 대문자로 작성하고 값과 주석 사이를 정렬합니다.
- 단일 행 주석은 `//`를 사용하며, 변경 이력 주석은 한국어로 작성합니다.
- 함수 선언/정의 사이에는 한 줄을 비워 가독성을 유지합니다.

## 빌드 및 테스트
- 기본 빌드: `cmake -S . -B build -DKEYBOARD_PATH='/keyboards/era/sirind/brick60'`
- 컴파일: `cmake --build build -j10`
- UF2 변환은 CMake 타겟 내부에서 자동 처리됩니다.

## 디렉터리 힌트
- `src/` : 펌웨어 소스 및 라이브러리 전반.
- `src/ap/` : 애플리케이션 계층과 QMK 포팅.
- `src/hw/` : 하드웨어 추상화 및 펌웨어 버전 정의.
- `src/bsp/` : 보드 초기화, 클럭, 스타트업 코드.
- `tools/` : 빌드 및 UF2 보조 스크립트.

## PR 작성 지침 (한국어)
- PR 제목과 본문은 한국어로 작성합니다.
- 변경 요약과 테스트 결과를 포함하되, 현재 펌웨어 버전 문자열(예: `V250928R5`)을 명시합니다.
- 후속 작업 PR을 작성할 경우 기존 요약을 유지하며 의미 있는 변경만 추가합니다.

## 추가 주의사항
- USB 모니터는 750ms 워밍업, HS 2048 마이크로프레임 또는 2.75초 타임아웃 후 활성화됩니다.
- 타이머/USB 경로 변경 시 8000Hz 스케줄링 유지 여부를 반드시 검토합니다.
- QMK 업스트림을 병합할 때는 `quantum/`을 먼저 비교한 뒤 `port/`에서 플랫폼 수정을 재적용합니다.

## 응답 언어
- 모든 답변과 커밋 메시지는 한국어로 작성합니다.
