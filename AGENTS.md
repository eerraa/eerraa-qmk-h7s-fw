# Codex 작업 가이드

본 문서는 전체 저장소에 적용되며, 아래 순서대로 지침을 확인하십시오.

## 1. 필수 응답 규칙
- 모든 답변, 커밋 메시지, PR 본문은 **반드시 한국어**로 작성합니다.

## 2. 프로젝트 개요
- 대상 보드: STM32H7S (내장 HS PHY) — 기본 USB 폴링 주기 8000Hz.
- 지원 속도: HS 4k/2kHz, FS 1kHz. 정책은 HS 우선입니다.
- 주요 기능: USB instability monitor (마이크로프레임 격차 감시, V250924R4), 단계적 폴링 다운그레이드 큐, QMK 포팅층.

## 3. 작업 전 체크리스트
1. `_DEF_FIRMWATRE_VERSION`과 보드 매크로를 `src/hw/hw_def.h`에서 확인합니다.
2. 엔트리 경로는 `src/main.c → src/ap/ap.c` 흐름을 중심으로 파악합니다.
3. QMK 구조는 `src/ap/modules/qmk/{port,keyboards,quantum}` 순으로 확인합니다.
4. 다음 경로는 **고위험 파일군**으로 분류하여 변경 시 집중 리뷰합니다.
   - `src/ap/modules/qmk/port/sys_port.*`
   - `src/hw/driver/`

## 4. 변경 이력 규칙
- 코드 변경마다 `// VYYMMDDRn ...` 형식의 변경 이력 주석을 추가합니다. 동일 날짜 내 추가 수정 시 `Rn` 번호를 증가시킵니다.
- `_DEF_FIRMWATRE_VERSION`을 수정했다면 최신 `VYYMMDDRn`과 반드시 동기화합니다.

## 5. 코드 스타일 요약
- 들여쓰기는 공백 두 칸을 사용합니다.
- 함수 및 제어문 중괄호는 새 줄에 배치합니다.
- 조건문은 `if (cond) {`와 같이 괄호 앞뒤에 공백을 둡니다.
- 연산자는 `a + b` 형태로 좌우에 공백을 두되, 기존 코드가 공백 없이 연속 호출(`millis()-pre_time`)을 사용한다면 주변 컨벤션을 유지합니다.
- `#define` 상수는 대문자로 작성하고 값, 주석 사이 정렬을 맞춥니다.
- 단일 행 주석은 `//`를 사용하며, 변경 이력 주석은 한국어로 남깁니다.
- 함수 선언과 정의 사이에는 한 줄을 비워 가독성을 확보합니다.

## 6. 빌드 및 테스트
```bash
cmake -S . -B build -DKEYBOARD_PATH='/keyboards/era/sirind/brick60'
cmake --build build -j10
```
- UF2 변환은 CMake 타깃 내부에서 자동으로 처리됩니다.

## 7. 디렉터리 힌트
- `src/` : 펌웨어 소스 및 라이브러리 전반
- `src/ap/` : 애플리케이션 계층과 QMK 포팅
- `src/hw/` : 하드웨어 추상화 및 펌웨어 버전 정의
- `src/bsp/` : 보드 초기화, 클럭, 스타트업 코드
- `tools/` : 빌드 및 UF2 보조 스크립트

## 8. PR 작성 지침
- PR 제목과 본문은 한국어로 작성합니다.
- 변경 요약과 테스트 결과를 명시하고, 현재 펌웨어 버전 문자열(예: `V250928R5`)을 포함합니다.
- 후속 PR이라면 기존 요약을 유지한 채 의미 있는 변경만 추가로 기술합니다.

## 9. 추가 주의사항
- USB 모니터는 750ms 워밍업 후 HS 2048 마이크로프레임 또는 2.75초 타임아웃 조건을 만족하면 활성화됩니다.
- 타이머/USB 경로를 변경할 때는 8000Hz 스케줄링이 유지되는지 검증합니다.
- QMK 업스트림 병합 시 `quantum/`을 먼저 비교하고, 이후 `port/`에서 플랫폼 수정을 재적용합니다.

## 10. 참고 팁
- 저장소 전반의 디버그 로그는 `src/hw/hw.c` 초기화 루틴과 연동되어 있으므로, 버전 문자열 출력 경로를 수정할 때는 전역 영향 범위를 검토하세요.
- 장기 실행 타이머를 건드릴 경우 USB instability monitor의 워밍업/타임아웃 조건을 함께 확인하면 리그레션을 줄일 수 있습니다.
