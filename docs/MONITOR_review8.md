# MONITOR Review 8 (V251005R7)

## 개선안 후보 목록
1. SOF 모니터 캐시에 저장하는 마이크로초 파라미터(`expected_us`, `stable_threshold_us`, `decay_interval_us`)를 16비트로 축소해 ISR의 메모리 접근 폭을 줄인다.
2. 다운그레이드 큐(`usb_boot_mode_request_t`)에서도 `expected_us`, `missed_frames` 필드를 16비트로 정리해 메인 루프에서의 구조체 복사를 경량화한다.
3. `usbHidResolveDowngradeTarget()`을 순차 Enum 증가 계산으로 단순화해 분기 수를 줄인다.
4. 서스펜드 감지를 `pdev->dev_state` 비교로 대체해 `USBD_is_suspended()` 호출을 제거한다.

---

### 후보 1. SOF 모니터 파라미터 캐시 16비트 축소
- **요약**: `usb_sof_monitor_t`와 파라미터 테이블에서 마이크로초 단위 캐시를 `uint16_t`로 축소해 구조체 크기와 저장 폭을 줄인다.
- **성능 영향**: ISR에서 해당 필드를 읽고 쓰는 동작이 절반 폭(16비트)으로 줄어들어 버스 접근이 축소된다. 값 범위(≤20,000µs)가 작아 오버플로우 위험이 없으므로 계산 비용은 동일하게 유지된다.
- **복잡도 영향**: 타입 변경 외 추가 분기나 보정이 필요 없으며, 기존 캐시·복사 흐름이 그대로 유지된다. 코드 이해도에 변화가 없다.
- **USB 불안정성 영향**: 감시 임계값이 동일하게 유지되고, 계산 시 32비트 로컬 변수로 승격되므로 비교·나눗셈 로직은 기존과 동일하게 동작한다. 범위 내 값만 저장하므로 오동작 위험이 없다.
- **결론**: **채택**.

### 후보 2. 다운그레이드 큐 파라미터 16비트 경량화
- **요약**: `usb_boot_mode_request_t` 구조체에서 `expected_us`, `missed_frames`를 `uint16_t`로 축소한다.
- **성능 영향**: 메인 루프(`usbProcess`)에서 구조체 필드를 읽을 때 더 작은 폭을 사용하게 되어 로드/스토어 수가 줄고, `usbRequestBootModeDowngrade()` 호출 시 스택 복사량이 감소한다.
- **복잡도 영향**: 타입만 변경하며, 큐 로직이나 상태 머신에는 변화가 없다.
- **USB 불안정성 영향**: 해당 필드는 최대 20,000µs, 수십 프레임 수준만 저장하므로 16비트 범위에 충분하다. 로그·판정 로직에서 32비트로 승격되어 기존 계산과 동일하게 동작해 오동작 가능성이 없다.
- **결론**: **채택**.

### 후보 3. 다운그레이드 타깃 계산 단순화
- **요약**: `usbHidResolveDowngradeTarget()`을 `cur_mode + 1` 형태의 순차 증가 계산으로 교체해 switch 분기를 제거한다.
- **성능 영향**: 조건 분기가 한 번의 범위 비교로 줄어들어 다운그레이드 경로에서의 분기 예측 부담이 감소한다. 호출 빈도는 낮지만 코드 크기가 축소된다.
- **복잡도 영향**: Enum 순서를 이용하는 간단한 산술로 변경되어 이해도가 오히려 향상된다.
- **USB 불안정성 영향**: Enum 값이 연속 정수(0~3)로 정의되어 있어 `FS_1K` 이상에서는 `USB_BOOT_MODE_MAX`를 반환하도록 안전장치를 유지할 수 있다. 다운그레이드 시퀀스가 기존과 동일하게 유지된다.
- **결론**: **채택**.

### 후보 4. 서스펜드 감지를 dev_state 비교로 대체
- **요약**: `USBD_is_suspended()` 대신 `pdev->dev_state`가 `USBD_STATE_SUSPENDED`인지 확인해 서스펜드 감지를 수행한다.
- **성능 영향**: 함수 호출 한 번을 줄일 수 있으나, 실제 스택 구현에서 `dev_state`가 `CONFIGURED`로 유지된 채 서스펜드가 전달되는 사례가 있어 보조 API 호출이 필요할 수 있다.
- **복잡도 영향**: 스택 구현 차이를 고려한 추가 분기와 상태 캐시가 필요해, 현재보다 코드가 복잡해질 가능성이 있다.
- **USB 불안정성 영향**: 스택이 dev_state를 갱신하지 않는 경우 서스펜드 이벤트를 놓칠 수 있어 탐지 로직이 동작하지 않을 위험이 있다.
- **결론**: **보류** (비선택).

---

## 최종 채택 개선안
- SOF 모니터 파라미터 캐시를 16비트로 축소해 ISR에서의 메모리 접근 폭을 줄였다.
- 다운그레이드 큐의 `expected_us`, `missed_frames` 필드를 16비트로 줄여 상태 머신의 메모리 사용량을 경량화했다.
- `usbHidResolveDowngradeTarget()`을 순차 Enum 계산으로 단순화해 다운그레이드 분기 비용을 줄였다.

## USB 불안정성 탐지 흐름 재검증 메모
1. **상태 전환**: `usbHidSofMonitorPrime()`이 호출되면 32비트 타이밍 필드는 그대로 초기화되고, 16비트로 축소된 기대 간격/임계값이 `usbHidSofMonitorApplySpeedParams()`를 통해 채워진다.
2. **홀드오프/워밍업**: 홀드오프 동안 `usbHidSofMonitorSyncTick()`이 여전히 타임스탬프를 유지하며, 워밍업 카운터와 타임아웃 비교는 16비트 캐시를 32비트로 승격해 동일하게 수행된다.
3. **안정 감시**: 워밍업이 끝나면 `expected_us`/`stable_threshold_us`를 32비트 로컬에 읽어 `usbCalcMissedFrames()`와 패널티 계산이 기존과 동일하게 진행된다.
4. **다운그레이드 큐 연동**: 새로 경량화된 `usbHidResolveDowngradeTarget()`이 다음 모드를 산출하고, 큐에는 16비트 `expected_us`/`missed_frames`가 저장되지만 `usbBootModeRequestMissedFrames()`가 필요 시 32비트로 승격해 재계산한다.
5. **메인 루프 처리**: `usbProcess()`는 축소된 필드를 이용해 로그/타임아웃을 처리하며, Stage 캐시·타임아웃 비교는 기존과 동일하게 유지되어 USB 불안정성 탐지 동작이 변하지 않음을 확인했다.
