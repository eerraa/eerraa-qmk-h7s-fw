# MONITOR Review 11 (V251006R1)

## 개선안 후보 목록
1. 홀드오프·비구성 구간에서 `usbHidSofMonitorSyncTick()`이 `last_decay_us`를 매번 덮어쓰지 않고, 점수가 존재할 때만 동기화한다.
2. 워밍업 단계에서는 `expected_us` 캐시를 건드리지 않고, 안정 감시 구간에 진입했을 때만 로드한다.
3. 워밍업에서 안정 임계 초과가 발생하면 즉시 다운그레이드 점수를 누적해 초기 감시를 더 공격적으로 만든다.

---

### 후보 1. `last_decay_us` 조건부 동기화
- **성능 영향**: 홀드오프·비구성 상태는 감시가 비활성인 기간으로, 매 SOF마다 `last_decay_us`를 덮어쓰는 것은 AHB 쓰기 두 번 중 하나를 낭비한다. 점수가 0일 때는 감쇠 비교가 이루어지지 않으므로, 해당 쓰기를 생략하면 워밍업 2048프레임 동안 약 50%의 구조체 쓰기를 절감할 수 있다.
- **복잡도 영향**: 조건문 한 줄과 주석만 추가되어 기존 흐름은 그대로 유지된다. 호출부 수정이 필요하지 않아 유지보수 부담이 늘지 않는다.
- **USB 불안정성 영향**: 점수가 0일 때 감쇠 기준 시각이 최신으로 유지되지 않아도, 이후 패널티가 누적되는 순간 `last_decay_us`를 즉시 갱신한다. 다운그레이드 판정·감쇠 로직은 점수>0 조건에서만 실행되므로 오동작 위험이 없다.
- **결론**: **채택**.

### 후보 2. `expected_us` 접근 지연
- **성능 영향**: 워밍업 구간에서는 `expected_us` 값을 사용하지 않는데도 매 프레임 로드한다. 안정 감시 단계에서만 읽도록 지연하면 2048/128프레임 워밍업 동안 16비트 로드가 제거되고, 안정 구간에서도 정상 프레임(임계 미초과)에서는 접근하지 않는다.
- **복잡도 영향**: 로컬 변수를 안정 감시 분기 내부로 옮기고 0 체크를 해당 분기에서만 수행한다. 제어 흐름 변경은 없으며, 기존 반환 경로를 그대로 활용한다.
- **USB 불안정성 영향**: 속도 파라미터가 없는 경우(비구성/알 수 없는 속도)는 원래도 즉시 반환했다. 접근 지연 후에도 `expected_us == 0`이면 패널티 계산을 생략하고 기존과 동일하게 리턴하므로 탐지 민감도와 다운그레이드 흐름이 변하지 않는다.
- **결론**: **채택**.

### 후보 3. 워밍업 단계에서 즉시 점수 누적
- **성능 영향**: 워밍업 중에도 패널티를 누적하면 이후 감시가 빨리 수렴할 수 있으나, 워밍업 절차가 복잡해지고 분기 수가 증가한다.
- **복잡도 영향**: 워밍업과 정상 감시 경계를 다시 정의해야 하며, 워밍업 타임아웃/홀드오프와의 상호작용이 늘어나 코드 복잡도가 급증한다.
- **USB 불안정성 영향**: 케이블 연결 직후의 일시적인 지터를 불안정으로 오인해 조기 다운그레이드를 일으킬 수 있다. 기존 정책(2048/128프레임 검증)을 훼손하므로 오동작 위험이 매우 크다.
- **결론**: **기각** (워밍업 안정성 저하 우려).

---

## 최종 채택 개선안
- 점수가 누적되지 않은 동안에는 `usbHidSofMonitorSyncTick()`이 `last_decay_us`를 덮어쓰지 않아 워밍업·홀드오프 구간의 구조체 쓰기를 줄였다.
- 안정 감시 단계에서만 `expected_us`를 로드하도록 지연해 워밍업과 정상 프레임에서의 메모리 접근을 줄였다.

## USB 불안정성 탐지 흐름 재검증 메모
1. **상태 전환/홀드오프**: Prime 이후 홀드오프에서 `last_decay_us`는 더 이상 매 프레임 갱신되지 않지만, 점수 0 상태라 감쇠 비교가 발생하지 않는다. 다운그레이드가 발생하면 즉시 `last_decay_us`를 갱신하므로 감쇠 기준이 뒤쳐지지 않는다.
2. **워밍업 단계**: `expected_us` 접근이 지연돼도 워밍업 로직은 `stable_threshold`와 워밍업 타임아웃만으로 동작한다. 워밍업 완료 시점에 `last_decay_us`를 그대로 `now`로 갱신하므로 정상 감시에 필요한 기준이 확보된다.
3. **정상 감시/감쇠**: `delta_us < stable_threshold` 분기에서는 `expected_us`를 로드하지 않으므로 구조체 접근이 제거된다. 지연 접근 이후에도 패널티 계산과 다운그레이드 판정은 동일하며, `expected_us == 0`이면 기존처럼 즉시 반환한다.
4. **다운그레이드 큐 연동**: ISR이 `expected_us`를 안정 구간에서만 읽지만, 큐로 전달되는 값은 여전히 최신 캐시를 사용한다. 0인 경우 요청 자체가 발생하지 않아 기존 안전장치와 동일하다.

