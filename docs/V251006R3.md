# MONITOR Review 13 (V251006R3)

## 개선안 후보 목록
1. SOF ISR 진입 초기에 `pdev->dev_speed`를 한 번만 읽어, 상태 전환 Prime 경로와 서스펜드 분기에서 모두 재사용한다.
2. `usbHidSofMonitorApplySpeedParams()`에서 속도별 파라미터를 직접 인덱스로 적용하도록 단순화해 분기 비용을 제거한다.
3. `USBD_is_suspended()` 호출을 `pdev->dev_state == USBD_STATE_SUSPENDED` 비교로 대체해 함수 호출을 제거한다.

---

### 후보 1. SOF ISR `dev_speed` 단일 로드 공유
- **성능 영향**: 현재는 상태 전환이 발생하면 Prime 경로에서 `pdev->dev_speed`를 한 번 읽고, 이후 정상 감시 분기에서 다시 읽는다. ISR 내에서 속도가 바뀌지 않으므로 초기에 한 번만 읽어 전 구간에서 재사용하면 AHB 액세스를 1회 절감하고, Prime 경로에서도 동일한 캐시 값을 활용할 수 있다.
- **복잡도 영향**: 초기에 변수를 하나 선언하고 기존 분기에서 해당 변수를 사용하도록 치환하는 정도라 흐름이 변하지 않는다. 가독성도 `dev_speed`가 어디에서 유래했는지 더 명확해진다.
- **USB 불안정성 영향**: Prime 호출과 서스펜드/복귀 분기는 모두 동일 프레임의 속도 값을 사용하므로 동작 변화가 없다. 속도 변경 자체는 다음 SOF에서 Prime이 다시 실행되면서 감지되기 때문에 탐지 민감도에 영향이 없다.
- **결론**: **채택**.

### 후보 2. 속도 파라미터 테이블 직접 인덱스 적용
- **성능 영향**: 기존 switch 분기는 두 개의 속도에 대해 포인터를 선택한 뒤 다시 `if (params != NULL)`로 나뉜다. 열거형 값이 테이블 순서와 일치하므로 기본값을 먼저 초기화한 뒤, 유효한 속도인 경우에만 직접 인덱싱하면 분기 두 개와 포인터 비교가 사라져 ISR에서의 분기 예측 부담이 줄어든다.
- **복잡도 영향**: 0/1 두 가지 인덱스만 허용하도록 범위를 명시하면 로직이 더 직관적이 된다. 기본값 초기화는 기존 else 블록과 동일해 가독성 저하가 없다.
- **USB 불안정성 영향**: 잘못된 속도 코드가 들어올 경우 기존과 동일하게 0으로 초기화된다. 유효 속도는 동일한 테이블 값을 사용하므로 감시 파라미터가 달라질 여지가 없다.
- **결론**: **채택**.

### 후보 3. `USBD_is_suspended()` 호출 제거
- **성능 영향**: 함수 호출 한 번을 상태 비교로 대체할 수 있어 보이나, ST USB 스택은 `USBD_is_suspended()` 내부에서 OTG 레지스터를 참조해 정확한 서스펜드 상태를 판별한다. 단순히 `pdev->dev_state`만 확인하면 클럭 게이트 상황에서 최신 상태를 놓칠 위험이 있다.
- **복잡도 영향**: 상태 추적을 새로 도입해야 하므로 오히려 코드가 복잡해진다.
- **USB 불안정성 영향**: 서스펜드 감지가 어긋나면 워밍업/홀드오프 재초기화가 제때 이루어지지 않아 다운그레이드 트리거가 늦어질 수 있다. 이는 오동작 위험으로 이어진다.
- **결론**: **미채택**.

---

## 최종 채택 개선안
- SOF ISR 시작 시 `pdev->dev_speed`를 로드해 상태 전환 Prime, 서스펜드/복귀 분기 모두에서 공유한다.
- 속도 파라미터 적용 함수를 테이블 직접 인덱싱 구조로 단순화해 분기와 포인터 비교를 제거했다.

## USB 불안정성 탐지 흐름 재검증 메모
1. **상태 전환/Prime**: `dev_state` 변화 시 동일 프레임에서 캐시한 `dev_speed`를 사용해 Prime이 실행되고, 비구성 상태에서는 즉시 타임스탬프만 동기화한다. 속도 변경은 다음 SOF에서 캐시된 값과 비교되어 Prime이 재호출되므로 기존과 동일하게 감지된다.
2. **서스펜드 처리**: 서스펜드 감지 및 복귀 Prime 호출에 동일한 캐시 변수를 사용하므로 추가 레지스터 접근이 없으며, 워밍업·홀드오프 재적용 흐름은 변하지 않는다.
3. **속도 파라미터 적용**: `usbHidSofMonitorApplySpeedParams()`는 기본값을 먼저 0으로 초기화한 뒤, HS/FS에 대해서만 테이블을 통해 값을 채운다. 덕분에 비구성/알 수 없는 속도에서도 이전 파라미터가 남지 않고, 유효 속도에서는 기존과 동일한 기대 간격·임계값이 적용된다.
4. **정상 감시/다운그레이드**: 점수 누적, 감쇠, 다운그레이드 큐 처리 경로는 변경되지 않았으며, `missed_frames` 계산과 포화 처리 시점도 기존과 동일하다. 따라서 탐지 민감도나 큐 동작은 그대로 유지된다.

