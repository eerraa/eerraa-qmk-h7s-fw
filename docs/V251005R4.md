## 개선안 후보 및 검토 결과
1. **SOF 누락 프레임 계산식 단순화**
   - 내용: `missed_frames` 계산을 `((delta_us - expected_us) / expected_us) + 1`에서 `delta_us / expected_us`로 단순화해 나눗셈 전후의 덧셈·뺄셈을 제거한다.
   - (1) 성능 영향: 감시 임계 구간에서만 실행되지만, SOF ISR 안에서 불필요한 산술 두 번을 제거해 분기 직후 파이프라인을 짧게 유지할 수 있다.
   - (2) 복잡도: 동일한 의미를 갖는 정수 나눗셈 한 줄로 대체되므로 로직 가독성이 오히려 향상된다.
   - (3) 비정상 작동 가능성: 임계 분기가 `delta_us >= stable_threshold (>= 2 * expected_us)` 조건에서만 실행되어 몫이 항상 2 이상이므로 기존 결과와 완전히 동일하다.
   → **채택**

2. **다운그레이드 로그용 누락 프레임 캐시 재사용 보장**
   - 내용: `usbBootModeRequestMissedFrames()`가 큐에 저장된 `missed_frames` 캐시를 우선 반환하고, 비어 있을 때만 한 번 재계산 후 캐시에 반영하도록 수정한다.
   - (1) 성능 영향: 메인 루프에서의 로그 처리 시 불필요한 나눗셈을 제거해 ARM 단계 반복 호출 부담을 줄인다.
   - (2) 복잡도: 조건문 하나와 캐시 갱신만 추가되므로 구조가 단순하다.
   - (3) 비정상 작동 가능성: 캐시가 없는 예외 상황에서도 동일 공식을 재계산해 저장하므로 동작 변화가 없다.
   → **채택**

3. **SOF ISR에서 `millis()` 호출 제거**
   - 내용: `usbRequestBootModeDowngrade()`에 전달하는 시간 값을 `now_us / 1000`으로 변환해 별도의 `millis()` 호출을 생략한다.
   - (1) 성능 영향: ISR에서 HAL tick API를 호출하지 않게 되어 약간의 이득이 예상된다.
   - (2) 복잡도: 큐와 메인 루프가 서로 다른 기준시(`micros()` vs `HAL_GetTick()`)를 사용하게 되므로 시간 계산 경계 처리가 필요하다.
   - (3) 비정상 작동 가능성: 부팅 시점 기준 오프셋이 달라지면 ARM → COMMIT 전환 타이밍이 틀어질 수 있어 다운그레이드가 즉시 확정되거나 영원히 대기하는 오류가 발생할 위험이 크다.
   → **기각**

4. **Prime 단계 속도 파라미터 0 초기화 생략**
   - 내용: `usbHidSofMonitorPrime()`에서 파라미터 필드를 0으로 초기화하지 않고 즉시 `usbHidSofMonitorApplySpeedParams()`만 호출한다.
   - (1) 성능 영향: 구조체 초기화 다섯 줄을 건너뛰어 미세한 이득은 있으나, 호출 빈도가 낮아 체감이 어렵다.
   - (2) 복잡도: 명시 초기화를 제거하면 이전 속도 값이 남아 있는지 코드만으로 추론하기 어렵다.
   - (3) 비정상 작동 가능성: 서스펜드→복귀처럼 `speed_code`가 임시로 0xFF가 될 때 이전 파라미터가 남아 오검출을 일으킬 가능성이 있다.
   → **기각**

## 최종 반영 요약
- 개선안 1, 2를 적용해 SOF 임계 분기의 누락 프레임 산출을 단일 정수 나눗셈으로 축소하고, 큐 로그 경로는 캐시된 값을 재사용하도록 정리했다.
- 변경 후 `usbHidMonitorSof()`가 상태 변화 감지 → 워밍업 → 임계 초과 시 점수 가산 → 다운그레이드 요청까지 이어지는 흐름과, `usbProcess()`가 ARM/COMMIT 단계를 처리하며 캐시된 `missed_frames`를 로그에 활용하는 경로를 재검증했다.
