# MONITOR Review 26 — 후보 개선안 검토 (V251007R7)

## 1. 후보 개선안 목록
1. **`usbRequestBootModeDowngrade()` Stage 분기를 `switch`로 통합**
2. **`usbProcess()` 로그 경로에서 `missed_frames` 임시 변수 제거**
3. **`usbBootModeRequestReset()`을 구조체 리터럴 대입으로 단순화**

## 2. 후보별 검토
### 1) `usbRequestBootModeDowngrade()` Stage 분기를 `switch`로 통합
- **성능 영향**: 기존 구현은 동일 함수에서 `stage`를 두 번 비교하며, 각 분기 안에서 `now_ms_valid` 플래그로 `millis()` 호출을 제어했다. `switch`로 재구성하면 한 번의 분기만 수행되며, 각 Case 안에서 즉시 `millis()`를 호출해 불필요한 불리언 검사와 초기 0 대입을 제거할 수 있다. 다운그레이드 큐는 ISR 이후 경로이지만, COMMIT 대기 동안 반복 호출되므로 이 비용 절감이 누적된다.
- **복잡도 변화**: Stage 흐름이 IDLE→ARMED→COMMIT 순서로 명확하게 배열되어 오히려 가독성이 향상된다. `now_ms_valid` 플래그가 사라져 상태 변수가 줄어들고, `confirm_delay_ms` 계산도 Case 내부에 국한돼 유지보수가 쉬워진다.
- **USB 불안정성 탐지 리스크**: `ready_ms`와 `timeout_ms` 계산식은 기존과 동일한 상수를 사용해 `now + delay`, `now + 2 * delay` 관계를 그대로 보존한다. Stage 전환 및 로그 플래그 갱신 로직도 동일하게 유지되어 ARM→COMMIT 흐름에 변화가 없다.
- **결론**: 적용.

### 2) `usbProcess()` 로그 경로에서 `missed_frames` 임시 변수 제거
- **성능 영향**: 로그 출력 전용으로 16비트 캐시를 32비트 임시 변수에 복사하던 경로를 제거하면, 다운그레이드 로그가 발생할 때 불필요한 로드/스토어 한 쌍이 줄어든다. 희귀 이벤트지만, 큐가 ARM 상태에서 반복 로그를 검사할 때마다 중복 복사가 제거된다.
- **복잡도 변화**: `%lu` 포맷에 맞춰 `(unsigned long)`으로 직접 캐스팅해 전달하면 코드가 더 짧아져 로직이 단순해진다.
- **USB 불안정성 탐지 리스크**: 누락 프레임 캐시는 ISR에서 최소 1 이상으로 정규화돼 있으며, 16비트 값을 32비트로 승격해 출력하는 동작은 기존과 동일하다. 로그 외의 다른 경로에는 영향을 주지 않는다.
- **결론**: 적용.

### 3) `usbBootModeRequestReset()`을 구조체 리터럴 대입으로 단순화
- **성능 영향**: 구조체 리터럴로 초기화하면 다중 필드 대입을 한 번의 `memcpy` 형태로 바꿀 수 있지만, 현재 구현은 필드 수가 적고, Stage·NextMode 기본값을 명시적으로 기록하고 있다. 실제 성능 개선은 미미하다.
- **복잡도 변화**: 구조체 리터럴을 사용할 경우 필드가 추가될 때 초기화 누락을 발견하기 어렵고, Stage/Mode 기본값을 한눈에 확인하기 힘들어진다. 유지보수 시 구조체 정의와 초기화 코드를 동시에 확인해야 하는 부담이 커진다.
- **USB 불안정성 탐지 리스크**: 초기화 대상 필드가 늘어날 때 구조체 리터럴에 반영되지 않으면 Stage가 예상치 못한 값으로 시작할 수 있다. 큐 상태가 깨지는 것은 모니터 동작 전체에 치명적이므로 보수적인 접근이 필요하다.
- **결론**: 미적용.

## 3. 최종 적용 내역
- 후보 1을 적용해 `usbRequestBootModeDowngrade()`가 Stage별 `switch`에서 즉시 타임스탬프를 획득하도록 정리하고, `now_ms_valid` 보조 플래그를 제거했다.
- 후보 2를 반영해 `usbProcess()` 로그 경로가 누락 프레임 캐시를 직접 캐스팅하도록 단순화했다.
- 변경 후 `usbHidMonitorSof()` → `usbRequestBootModeDowngrade()` → `usbProcess()` 순으로 따라가며 ARM/COMMIT 전환, 확인 지연, 타임아웃 처리 및 로그 출력이 기존과 동일하게 진행되는지 재검증했다.
