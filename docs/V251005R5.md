# MONITOR Review 6

## 개선안 후보 목록

1. **점수 누적 경로의 8비트 예산 비교화**
   - 설명: SOF 지터 감지 시 `score + penalty`를 32비트로 합산하는 대신, 남은 임계 예산(`degrade_threshold - score`)과 누적 패널티를 8비트로 비교해 감산/증가를 결정한다.
   - 성능 영향: 32비트 덧셈과 비교를 제거해 ISR 내 산술 명령 수를 줄일 수 있어 미세하지만 반복 호출(8kHz)에서 누적 이득이 기대된다.
   - 복잡도 영향: 분기 구성이 명확한 `budget` 비교로 바뀌며, 오히려 가독성이 소폭 향상된다.
   - 비정상 작동 위험: 임계/점수 범위가 모두 8비트 이내로 제한돼 있어 오버플로우 위험이 없고, 기존 로직과 동일한 조건에서 다운그레이드가 발생함을 검토했다. → **채택**

2. **감쇠 타이머 비교의 차분 연산화**
   - 설명: `last_decay_us + decay_interval_us`와 보조 함수를 이용한 비교 대신, `elapsed = now_us - last_decay_us`를 활용한 단순 비교로 감쇠 조건을 판정한다.
   - 성능 영향: 덧셈과 인라인 비교 함수를 제거해 분기 전 산술을 1회 줄인다.
   - 복잡도 영향: 경과 시간을 직관적으로 표현해 로직이 간결해진다.
   - 비정상 작동 위험: 32비트 타이머가 래핑되더라도 unsigned 차분은 동일하게 동작하며, 기존과 동일하게 감쇠가 1회만 수행됨을 확인했다. → **채택**

3. **워밍업 실패 시 카운터 절반 감산**
   - 설명: 불안정 프레임 발생 시 워밍업 카운터를 0으로 초기화하는 대신 절반으로만 감소시켜 재워밍업 속도를 높인다.
   - 성능 영향: 산술이 늘어나며 워밍업 루프가 복잡해진다.
   - 복잡도 영향: 추가 분기와 나눗셈이 필요해 ISR 가독성이 떨어진다.
   - 비정상 작동 위험: 순간적인 큰 지터가 발생했을 때 워밍업이 충분히 진행되지 않은 상태에서 감시가 재개될 수 있어 오검출 위험이 커진다. → **보류**

4. **홀드오프 구간에서 `prev_tick_us` 업데이트 생략**
   - 설명: 홀드오프 동안 이전 타임스탬프를 유지해 다음 비교에서 델타를 크게 만들고, 이후 1회만 측정하도록 한다.
   - 성능 영향: 산술 자체는 줄지만, 홀드오프 직후 첫 비교에서 초과 델타가 폭증해 불필요한 패널티 계산이 발생한다.
   - 복잡도 영향: 상태 전이를 추가 추적해야 해 로직이 복잡해진다.
   - 비정상 작동 위험: 홀드오프 종료 후 즉시 다운그레이드가 잘못 트리거될 수 있어 안정성이 크게 저하된다. → **기각**

## 채택한 개선 및 코드 반영 계획
- 점수 누적 경로의 8비트 예산 비교화.
- 감쇠 타이머 비교의 차분 연산화.

## 흐름 재검증 메모
- `usbHidMonitorSof()` → 워밍업/홀드오프 분기 → 점수 누적 → 임계 도달 시 `usbRequestBootModeDowngrade()` 호출 경로를 따라가며, 변경된 산술이 기존 조건과 동일한 분기를 생성함을 검증했다.
- 다운그레이드 큐(`usbProcess`)는 전달받는 `missed_frames` 값이 유지되므로 로그/재시도 시나리오에 영향이 없는 것을 확인했다.
