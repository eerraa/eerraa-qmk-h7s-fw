# MONITOR Review 21 — 후보 개선안 검토 (V251007R2)

## 1. 후보 개선안 목록
1. **속도 파라미터 적용 시 불필요한 0 초기화 제거**
2. **속도 변경 Prime 이후 즉시 반환 경로 추가**
3. **감쇠 타이머 갱신 조건 완화**

## 2. 후보별 검토
### 1) 속도 파라미터 적용 시 불필요한 0 초기화 제거
- **성능 영향**: `usbHidSofMonitorApplySpeedParams()`가 유효 속도에서도 모든 필드를 0으로 초기화한 뒤 다시 테이블 값을 덮어쓰고 있다. HS/FS 전환 시마다 6회 쓰기가 중복되므로, 유효 속도일 때는 곧바로 테이블 값을 복사하고, 알 수 없는 속도에서만 0 초기화를 수행하면 불필요한 메모리 쓰기를 줄일 수 있다.
- **복잡도 변화**: 조건 분기가 기존에도 존재하며, if-else로 초기화 대상을 명확히 분리하면 오히려 의도가 분명해진다. 추가 상태 관리가 없으므로 복잡도 증가는 없다.
- **USB 불안정성 탐지 리스크**: 속도 파라미터는 유효 속도에서 항상 테이블을 참조하므로, 0 초기화를 생략해도 값의 일관성이 유지된다. 알 수 없는 속도에서는 여전히 0으로 초기화해 감시 비활성화를 보장한다. 비정상 동작 위험은 없다.
- **결론**: 적용.

### 2) 속도 변경 Prime 이후 즉시 반환 경로 추가
- **성능 영향**: 속도 변경으로 Prime이 호출된 프레임은 이후에도 홀드오프·워밍업 분기를 통과해야 하므로, 잔여 로직을 실행한 뒤 다시 `usbHidSofMonitorSyncTick()`으로 현재 시각을 기록하고 있다. Prime 직후 즉시 반환하면 같은 프레임에서의 중복 분기와 동기화 호출을 줄여 ISR 실행 시간을 절약할 수 있다.
- **복잡도 변화**: Prime 호출 뒤 `return`을 추가하는 단순 변경으로, 흐름이 “상태 전환 처리 → 즉시 종료” 형태로 더 명확해진다.
- **USB 불안정성 탐지 리스크**: Prime 내부에서 타임스탬프와 워밍업 상태를 이미 초기화하므로, 같은 프레임에서 추가 처리를 생략해도 다음 SOF부터 홀드오프/워밍업이 정상 진행된다. 다운그레이드 판정에는 영향이 없다.
- **결론**: 적용.

### 3) 감쇠 타이머 갱신 조건 완화
- **성능 영향**: 현재는 임계 초과 프레임에서 `last_decay_us`를 즉시 `now_us`로 갱신한다. 이를 “감쇠가 실제로 실행될 때만 갱신”하도록 바꾸면 일부 쓰기를 줄일 수 있으나, 다음 안정 프레임에서 감쇠 비교를 할 때 추가 분기와 재계산이 필요해질 수 있다.
- **복잡도 변화**: 감쇠 타이머 업데이트 시점을 늘리면 `elapsed` 계산과 분기를 더 복잡하게 추적해야 한다.
- **USB 불안정성 탐지 리스크**: 감쇠 타이머가 늦게 갱신되면, 긴 간격 후 안정 프레임에서 과도하게 점수가 깎여 다운그레이드 트리거 타이밍이 바뀔 수 있다. 이는 오탐/미탐을 유발할 위험이 크다.
- **결론**: 미적용.

## 3. 최종 적용 내역
- 후보 1, 2를 채택하여 속도 파라미터 캐시 초기화를 최적화하고, 속도 변경 Prime 이후 즉시 반환해 SOF ISR 경로를 경량화한다.
