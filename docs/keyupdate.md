# `keysUpdate()` 제거 검토 보고서

## 1. 배경 및 목적
- DMA 순환 버퍼 기반 매트릭스 스캔이 도입된 이후에도 `keysUpdate()` 더미 함수가 헤더와 구현 파일에 남아 있습니다.【F:src/common/hw/include/keys.h†L13-L19】【F:src/hw/driver/keys.c†L298-L312】
- QMK 브리지의 실제 스캔 경로는 DMA 버퍼 포인터를 직접 참조하며, `keysUpdate()` 호출 경로는 `#else` 폴백 블록과 CLI 디버그 루프에만 잔존합니다.【F:src/ap/modules/qmk/port/matrix.c†L60-L92】【F:src/hw/driver/keys.c†L334-L376】
- 본 문서는 제안 A(`keysUpdate()` 제거)의 영향 범위와 부작용 가능성을 검토하고, 안전한 제거 계획을 수립하기 위해 작성되었습니다.【F:docs/features_keyinput_review.md†L12-L35】

## 2. 영향 범위 식별
| 구분 | 세부 내용 | 영향 분석 |
| --- | --- | --- |
| API 선언부 | `keys.h`에 `keysUpdate()` 프로토타입이 노출되어 외부 모듈에서 호출 가능 | 현재 실사용 경로는 `matrix.c` 폴백 블록과 `keys.c` CLI 루프뿐이며, 다른 모듈에서는 참조되지 않음. 제거 시 공개 API 축소 필요.【F:src/common/hw/include/keys.h†L13-L19】 |
| 구현부 | `keys.c` 내 구현이 `true`만 반환하는 더미 상태 | DMA 기반 드라이버에서는 실질적인 동작이 없어 제거 시 런타임 영향 없음.【F:src/hw/driver/keys.c†L298-L312】 |
| QMK 매트릭스 폴백 | `#else` 블록에서 소프트웨어 스캔 시 호출 | 현재 `#if 1`으로 DMA 경로가 고정되어 폴백이 비활성화 상태. 추후 폴백을 재활성화하려면 대체 루틴 마련 필요.【F:src/ap/modules/qmk/port/matrix.c†L74-L92】 |
| CLI 키 매트릭스 뷰어 | 반복 루프 내 `keysUpdate()` 호출로 기존 폴링 루틴 호환성 유지 의도 | 함수가 무동작이므로 제거해도 DMA 버퍼 갱신에는 영향이 없으나, 폴백 모드를 수동 호출하던 과거 CLI와의 호환성은 사라짐.【F:src/hw/driver/keys.c†L334-L376】 |

## 3. 잠재 부작용 및 리스크 평가
1. **폴백 스캔 재사용성 감소**: 향후 DMA 경로 장애 시 `#else` 블록을 재활성화하면 `keysUpdate()` 호출이 사라진 상태에서 행/열 스캔이 누락될 수 있음. → 대응: 폴백 로직 자체를 `keysScanLegacy()` 등 새 함수로 분리하거나, DMA 드라이버와 별도 파일로 보관.
2. **CLI 유지 보수성**: `keysUpdate()` 제거 후 CLI 루프는 DMA 버퍼를 직접 조회하므로 동작에는 변화가 없지만, 과거 문서에 기재된 사용법과 일치하지 않을 수 있음. 관련 문서를 업데이트해야 함.
3. **API 변경 공지 필요**: 외부에서 `keysUpdate()` 호출을 기대하던 코드가 있다면 컴파일 오류가 발생. 현재 저장소에서는 사용 사례가 없으나, 포팅 코드 병합 시 주의를 요함.

## 4. 제거 절차 제안
1. **API 정리**
   - `keys.h`에서 `keysUpdate()` 선언을 삭제하고, 필요 시 대체할 레거시 스캔 API 명세를 문서화.
2. **구현 제거**
   - `keys.c`의 더미 함수를 제거하고, 동일 위치에 DMA 기반 동작을 설명하는 주석을 추가해 레거시 호출 경로가 불필요함을 명시.
3. **호출부 정리**
   - `matrix.c` 폴백 블록에서 `keysUpdate()` 호출을 삭제하고, 폴백 자체를 `#if 0` 처리하거나 별도 함수로 이동.
   - CLI 루프에서는 `keysUpdate()` 호출을 제거한 뒤 DMA 버퍼가 주기적으로 갱신됨을 주석으로 안내. 필요 시 `delay(10)` 유지로 UI 새로고침 주기를 보장.
4. **관련 문서 갱신**
   - `features_keyinput.md` 및 CLI 사용 설명서에서 레거시 폴링 함수 호출 안내를 제거하고, DMA 기반 모니터링 흐름을 반영.
5. **검증**
   - 기본 빌드(`cmake --build`)가 통과하는지 확인.
   - CLI `keys info` 명령 실행 시 행/열 출력이 정상적으로 갱신되는지 실장 보드에서 확인.

## 5. 권장 타임라인 및 후속 조치
- **1단계 (다음 릴리스)**: API/구현 제거 및 호출부 정리, 문서 업데이트.
- **2단계 (통합 테스트 주기)**: CLI 동작 및 DMA 스캔 안정성 검증, 필요 시 레거시 폴백 함수 재설계.
- **3단계 (장기)**: `matrix.c`의 폴백 블록을 완전히 제거하거나 독립 모듈로 분리하여 유지보수 범위를 축소.

## 6. 결론
- `keysUpdate()`는 현재 펌웨어의 DMA 기반 스캔 경로에서 기능적 역할이 없으며, 제거 시 런타임 부작용 가능성이 낮습니다.
- 제거 작업은 API 정리와 문서 갱신이 동반되어야 하며, CLI/폴백 경로에 대한 운영 팀 공지가 필요합니다.
- 상기 계획에 따라 순차적으로 제거를 진행하면 코드 간결화와 유지보수 비용 절감 효과를 기대할 수 있습니다.