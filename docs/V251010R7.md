# V251010R7 변경 요약

## 1. 코드 변경 개요
- `qbuffer`에 슬롯 예약/커밋/롤백/팝 API를 추가하여 HID 경로에서 단일 복사 슬롯을 직접 운용할 수 있도록 확장했습니다.
- HID 키보드/EXK 전송 경로를 슬롯 기반 구조로 재구성하고, `usbHidKick*Transfer()` 헬퍼를 통해 즉시 전송과 재시도 루틴을 통합했습니다.
- `USBD_HID_DataIn()`과 타이머 콜백을 슬롯 메타데이터와 연계하도록 정비하여 계측 훅과 USB 모니터 호출 위치를 유지했습니다.
- 펌웨어 버전을 `V251010R7`로 갱신했습니다.

## 2. 계측·모니터 경로 검증 시나리오
### 2.1 Poll Rate 계측 경로
1. SOF 인터럽트에서는 여전히 `usbHidMeasurePollRate()`가 호출되며, 신규 슬롯 API는 SOF 경로를 변경하지 않습니다.
2. `usbHidSlotNotifySend()`가 전송 성공 시점에 큐 잔량을 전달하므로, 기존 `usbHidInstrumentationOnReportDequeued()` 호출이 유지되어 폴링 주기 계산이 동일하게 동작합니다.
3. 큐 슬롯을 직접 전송하더라도 `usbHidInstrumentationNow()`를 사용하는 모니터 타임스탬프 흐름이 변하지 않아, Poll Rate 통계값이 기존과 동일한 기준으로 누적됩니다.

### 2.2 Scan Rate 계측 경로
1. 매트릭스 계측은 `usbHidSetTimeLog()`를 통해 전달되는 타임스탬프를 계속 사용하며, 슬롯 전송이 시작될 때 `usbHidSlotNotifySend()`가 지연 측정을 활성화합니다.
2. 즉시 전송이 성공한 경우에도 `usbHidInstrumentationOnImmediateSendSuccess()`가 동일하게 호출되므로 키 처리 시간 로그가 유지됩니다.
3. 큐 대기 후 전송되는 리포트는 `usbHidSlotMarkQueued()` 플래그로 구분되어 기존의 지연 히스토그램 계산 흐름을 그대로 따라갑니다.

### 2.3 HID 계측 경로
1. 슬롯 구조에 `_DEF_ENABLE_USB_HID_TIMING_PROBE` 전용 필드를 추가하여 계측이 비활성화된 빌드에서 구조체 크기가 변하지 않습니다.
2. `usbHidKickKeyboardTransfer()`는 전송 성공 시점에만 계측 훅을 호출하므로, 중복 측정이 발생하지 않습니다.
3. Data IN 완료 시 `qbufferPop()`으로 슬롯을 해제한 뒤 즉시 다음 전송을 시도하여, 인터럽트 지연 없이 큐가 소비되고 계측 요청 플래그가 정상적으로 초기화됩니다.

### 2.4 USB 불안정성 탐지 로직
1. SOF 처리 루틴(`usbHidMonitorSof`)은 변경하지 않았으며, `_USE_USB_MONITOR` 플래그에 따른 분기 구조도 기존과 동일합니다.
2. 슬롯 기반 전송으로 인해 IN 완료 시점이 앞당겨져도, 모니터는 SOF 타임스탬프만 활용하므로 점수 계산 및 다운그레이드 판단 로직이 영향을 받지 않습니다.
3. 서스펜드 상태 진입 시에는 여전히 `usbHidUpdateWakeUp()`이 호출되어 모니터 워밍업/홀드오프 조건이 유지됩니다.

## 3. 빌드 및 테스트 결과
- `cmake -S . -B build -DKEYBOARD_PATH='/keyboards/era/sirind/brick60'`
- `cmake --build build -j10`
- 빌드 산출물 생성 후 `build` 디렉터리를 정리했습니다.

