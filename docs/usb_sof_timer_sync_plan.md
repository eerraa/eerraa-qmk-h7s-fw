# USB SOF 타이머 동기화 개선 구상

## 1. 현상 요약
- 백업 전송용 TIM2는 USB OTG HS의 내부 트리거(ITR13)로 매 마이크로프레임마다 리셋되고 120카운트 시점에 비교 일치를 발생시키도록 구성되어 있습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1420-L1468】
- 계측 경로에서는 TIM2 펄스가 SOF 이후 얼마만큼 지연되어 발생했는지 `micros()` 기반으로 기록하고 있는데, 동일 창 안에서 80→129 µs처럼 점진적으로 증가한 뒤 0 µs 근처로 재설정되는 패턴이 반복됩니다.【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L96-L110】
- `micros()` 함수는 TIM5를 1 MHz로 설정해 절대 시간을 측정하므로, 위 드리프트는 TIM2 타이머 틱과 USB SOF 기준 사이의 주파수/위상 차이가 누적된 결과입니다.【F:src/hw/driver/micros.c†L13-L42】

## 2. 개선 목표
1. HS/FS 양쪽 모두에서 SOF 후 120 µs 백업 경로가 유지되도록 TIM2를 자동 보정합니다.
2. SOF 기반 보정은 주기당 한 번 이하의 연산만 수행해 CPU 점유율 증가를 피합니다.
3. 계측 매크로가 비활성화되어도 보정이 계속 동작하도록 핵심 루틴을 HID 본체에 통합합니다.

## 3. 제안된 보정 아키텍처
### 3.1 타이머 클럭 비율 측정
- SOF 인터럽트 시점(`USBD_HID_SOF` 루틴)에서 `micros()` 값을 캡처하고, TIM2 비교 인터럽트(`HAL_TIM_PWM_PulseFinishedCallback`)에서 다시 읽어 차이를 계산합니다. 기존 계측 훅이 동일한 정보를 수집하므로, 이를 보정기에서 재사용할 수 있게 공용 헬퍼를 추가합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1502-L1536】【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L96-L110】
- 캡처 주기는 HS 8 kHz, FS 1 kHz로 매우 짧아 누적 평균을 구하더라도 CPU 부담이 작습니다.

### 3.2 PI 보정 루프
- `error_us = target_delay_us - measured_delay_us` 오차를 계산하고, (i) 소규모 비례항(Kp)으로 즉시 보정, (ii) 장기 누적 오차(Ki 적분)를 통해 평균 주파수 차이를 흡수합니다.
- 보정 결과는 TIM2 비교 레지스터(혹은 오토릴로드)에 반영하여 다음 프레임부터 목표 지연을 맞춥니다. 주파수 차이가 미미하므로 ±1틱 단위의 미세 조정만 허용해 지터를 억제합니다.
- PI 상태값은 USB 속도 전환(HS⇄FS)이나 버스 리셋 시 초기화해 모드별로 독립된 기준을 유지합니다.

### 3.3 동작 시퀀스
1. SOF 진입 시 최신 `micros()`를 기록하고, 현재 속도에 맞춘 목표 지연(`120 µs`)과 기대 SOF 주기(125 µs 또는 1000 µs)를 갱신합니다.
2. TIM2 비교 인터럽트에서 실제 지연을 측정하고 PI 보정기를 호출합니다.
3. 계산된 `next_ccr_ticks` 값을 `__HAL_TIM_SET_COMPARE()`에 기록하고, 필요 시 `ARR` 값도 함께 업데이트합니다.
4. 반복 실행하며 오차의 장기 누적이 1틱 이내로 유지되는지 모니터링합니다.

## 4. FS 모드 고려 사항
- FS 모드에서도 동일한 SOF 콜백이 호출되므로, PI 보정기는 HS/FS 공용으로 동작합니다. 다만 1 kHz 주기에서는 샘플 간 간격이 길어지므로, 적분 계수(Ki)를 낮추고 오차 누적 허용치를 늘려 안정성을 확보합니다.
- FS 구간에서 오차가 커지는 경우(예: 호스트가 1000 Hz보다 빠르거나 느린 경우)에는 누적 오차 한도를 넘으면 강제 재초기화(보정값=기본값) 후 다시 적응하도록 설계합니다.

## 5. CPU 및 메모리 영향
- 추가 연산은 프레임당 덧셈/곱셈 몇 회 수준으로, 현재 HID 처리 루프보다 훨씬 가볍습니다. 메모리 증가는 PI 상태값(수 바이트)과 통계 버퍼 공유분으로 제한됩니다.
- 계측 매크로가 꺼져 있어도 동일한 경로에서 오차를 계산해야 하므로, 보정용 최소 캡처 변수(최근 SOF 타임스탬프 등)는 항상 유지하지만, 히스토그램 등 디버그용 대용량 버퍼는 그대로 조건부 유지됩니다.

## 6. 구현 단계 요약
1. `usb_hid.c`에 SOF/비교 인터럽트 공용으로 사용할 보정 상태 구조체와 초기화 코드를 추가합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1420-L1500】
2. SOF 핸들러에서 타임스탬프와 USB 속도 정보를 보정기로 전달하는 헬퍼를 호출하도록 변경합니다.
3. TIM2 비교 인터럽트에서 실제 지연 측정 후 PI 계산을 수행하고, 결과를 `CCR1`에 반영합니다.
4. 보정기가 추적 중인 오차, PI 상태, 최근 지연 등을 CLI 통계에 노출해 검증합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L90-L139】

## 7. 검증 시나리오
- HS/FS 각각에서 5분 이상 로그를 수집하여 지연 평균·최대값이 120 µs 근처에서 평형을 이루는지 확인합니다.
- 호스트 측 USB 재연결/속도 전환 시에도 초기화가 정상 동작해 추가 드리프트가 발생하지 않는지 점검합니다.
- 백업 경로가 동작하는 동안 HID 주요 루틴(키 스캔, 리포트 전송)이 시간 제한을 넘지 않는지 `usb debug` CLI로 병행 확인합니다.

## 8. 기대 효과와 잠재 리스크 평가
### 8.1 기대 효과
- **지연 안정성 확보**: usbhid rate 로그의 누적 증가가 제거되어, 버스 상태를 신속하게 파악하는 디버깅 툴로서의 신뢰성이 상승합니다. 이는 USB instability monitor가 백업 경로 지연을 이상 징후로 잘못 판단하는 사례를 줄여, 폴링 다운그레이드 정책의 오작동을 예방합니다.
- **백업 경로 신뢰성 향상**: SOF 기준으로 정확한 120 µs 지연이 유지되면, 호스트 전송 지연이 발생했을 때도 보조 경로가 일정한 시점에 트리거되어 입력 손실 가능성이 낮아집니다. 특히 고주파 입력(8 kHz) 환경에서 반복 키 입력 누락 위험을 줄일 수 있습니다.
- **복구 시간 단축**: 드리프트 누적 없이 즉시 타겟 지연을 회복하므로, 버스 리셋/속도 전환 직후에도 빠르게 정상 상태에 진입합니다. 이는 모니터가 “정상 수렴” 상태를 판단하는 데 필요한 워밍업 시간을 줄여 펌웨어 전환에 유리합니다.
- **FS 환경 호환성 향상**: HS 대비 느린 FS에서도 동일 보정 로직으로 일정 지연을 확보해, 펌웨어 버전 간 일관된 입력 타이밍을 유지합니다. FS 모드 사용 시 키 응답 체감 차이를 줄이는 부수적인 이점이 있습니다.

### 8.2 단점 및 부작용 가능성
- **튜닝 복잡도 증가**: PI 계수를 잘못 설정하면 오히려 타이머가 과보정되어 지연이 흔들릴 수 있습니다. 초기 Kp/Ki 값을 결정하기 위해 환경별 실측과 튜닝 과정이 필요합니다.
- **ISR 처리 시간 증가**: 보정 계산이 SOF·TIM 인터럽트에 추가되므로, 최악의 경우 인터럽트 중첩 시 지연이 길어질 가능성이 있습니다. 현재 연산량은 미미하지만, 향후 다른 기능이 추가될 경우 ISR 스택 여유를 재검토해야 합니다.
- **측정 의존성 확대**: `micros()` 타이밍 정확도나 오실레이터 안정성이 떨어질 때 보정 결과가 왜곡될 수 있습니다. 외부 오실레이터 이상이나 저전압 동작 등으로 타이머가 흔들리면 보정기가 오히려 지연을 악화시킬 수 있으므로, 에러 바운더리(예: ±20 µs)를 넘어가면 보정을 일시 중단하는 보호 로직이 필요합니다.
- **디버그 데이터 해석 변화**: 보정으로 지연 드리프트가 사라지면 기존 로그 패턴에 익숙한 개발자가 변화된 기준에 맞춰 분석 습관을 조정해야 합니다. 예컨대 지연 값이 일정하게 유지되는 만큼, 다른 이상 징후(초과 지연, 큐 잔량 등)에 더 민감하게 대응할 필요가 있습니다.

### 8.3 대응 전략
- PI 파라미터는 펌웨어 버전별로 문서화하고, 실측된 수렴 속도·오버슈트 자료를 함께 기록해 향후 유지보수 시 참고합니다.
- ISR 연산이 늘어나는 만큼, USB/타이머 인터럽트 우선순위를 재검토하고, 필요 시 `LL` 기반 레지스터 접근으로 코스트를 최소화합니다. 여기서 "LL"은 STM32Cube HAL보다 얇은 저수준 드라이버 계층(stm32h7xx_ll_*.h)과 직접 레지스터 접근을 활용해 함수 호출 오버헤드를 줄이는 방식을 의미합니다.
- 보정기가 허용 범위를 벗어나는 경우 기본값(120 µs)으로 되돌리는 페일세이프를 구현해, 측정 신뢰성이 떨어지는 환경에서 과도한 보정을 방지합니다.

## 9. 구현 결과 (V251010R9)
- **PI 파라미터 확정**: HS 모드는 `Kp=1/16`, `Ki=1/128`(integral shift 7)로 설정해 프레임당 ±1틱만 조정되도록 제한했습니다. FS 모드는 `Kp=1/32`, `Ki=1/512`(integral shift 9)로 보수적으로 동작하며, 적분 포화 한계를 ±32틱 범위로 묶어 장기 드리프트를 흡수합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L110-L150】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1510-L1576】
- **가드 및 리셋 로직**: HS/FS 각각 ±32 µs, ±80 µs 가드를 두고 초과 시 적분·CCR을 기본값(120틱)으로 즉시 복귀합니다. 속도 전환이나 버스 재구성 시에도 동일 루틴을 재사용해 재동기화 시간을 일정하게 유지합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L117-L176】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1580-L1616】
- **공용 타임스탬프 경로**: SOF와 TIM2 인터럽트에서 `micros()`를 직접 호출해 계측 비활성 빌드에서도 보정이 항상 동작합니다. 기존 `usbHidInstrumentationNow()` 의존성을 제거해 경로를 단일화했습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1044-L1052】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1620-L1630】
- **LL 기반 CCR 갱신**: HAL 호출 오버헤드를 줄이기 위해 `LL_TIM_OC_SetCompareCH1`로 비교값을 직접 기록하며, PI 루프 결과를 즉시 다음 프레임에 적용합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L104-L124】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1598-L1604】
- **계측 출력 확장**: `usbhid rate` CLI에 CCR, 오차, 적분 누산, 리셋/가드 카운트를 노출해 튜닝 및 검증 시 필요한 통계를 한 번에 확인할 수 있게 했습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L92-L129】【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L252-L279】
- **폴링 잔차 계측**: `usbhid rate` 출력이 송신 시각과 호스트 폴링 위상 차이로 누적 증가하는 문제를 해결하기 위해 IN 완료 간격을 기대 폴링 주기 기준으로 정규화한 잔차 통계를 추가했습니다. 전송 지연과 별도로 폴링 잔차가 보고돼 실제 지연 누적 여부를 즉시 판별할 수 있습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L32-L44】【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L88-L120】【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L319-L370】
- **상태 조회 API**: `usbHidTimerSyncGetState()`를 통해 ISR 내부 상태를 안전하게 스냅샷 하도록 구현해, CLI와 향후 모니터링 기능이 동일 데이터를 공유합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid_internal.h†L11-L33】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1634-L1661】

## 10. 재평가 및 V251011R1 개선
- **오차 누적 원인 재분석**: 사용자 로그에서는 `전송 지연`이 30 µs대에서 120 µs 직전까지 선형 상승 후 0에 가깝게 떨어지는 톱니파 패턴이 반복되었습니다. 이는 TIM2와 `micros()`가 동일 내부 오실레이터에 종속돼 있어 PI 루프가 실제 호스트 위상 오차를 감지하지 못한 채, 로컬 기준 120 µs만 유지한 결과입니다. SOF 대비 로컬 지연은 항상 120 µs로 기록되지만, 호스트 IN 폴링과의 위상은 그대로 표류했습니다.
- **호스트 잔차 기반 제어**: V251011R1에서는 타이머 트리거 직후 `USBD_HID_DataIn` 완료까지 대기한 시간을 잔차로 정의해 오차 신호로 사용합니다. 잔차가 목표(HS 5 µs, FS 880 µs)에서 벗어나면 wrap을 고려한 최소 오차로 환산해 PI 루프에 공급하고, ±1틱 제한 및 가드 로직은 유지하되 잔차 기반으로 동작하도록 재구성했습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1550-L1682】
- **상태/계측 확장**: 타이머 상태 구조체와 CLI 출력에 로컬 지연, 호스트 지연, 잔차, 목표 잔차를 추가해 교정 경향을 즉시 확인할 수 있습니다. `SOF/타이머` 행은 로컬 지연을, `타이머 위상` 행은 호스트 지연과 잔차를 분리해 보여 주도록 갱신했습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid_internal.h†L13-L24】【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L33-L44】【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L276-L300】
- **버전 관리**: 펌웨어 버전 문자열을 `V251011R1`로 갱신하고, 보정 초기화 경로가 잔차 상태를 함께 리셋하도록 정비해 비정상 상황 발생 시 빠르게 기본 상태로 복귀하도록 했습니다.【F:src/hw/hw_def.h†L9】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1500-L1520】
