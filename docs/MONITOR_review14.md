# MONITOR Review 14 (V251006R4)

## 개선안 후보 목록
1. `usbBootModeGetHsInterval()`에서 BootMode별 HS `bInterval` 값을 테이블로 정리해 분기 비용을 제거한다.
2. `usbHidExpectedPollIntervalUs()`가 BootMode를 직접 테이블로 변환해 기대 폴링 간격을 계산하도록 단순화한다.
3. `usbHidMeasurePollRate()`의 샘플 윈도우를 캐시 변수로 유지해 매 호출 시 분기 계산을 피한다.

---

### 후보 1. HS `bInterval` 테이블화
- **성능 영향**: 기존 switch 분기는 HS/FS 모드 전환 시마다 분기 예측 부담이 있었고, ISR에서 반복 호출되는 `usbBootModeGetHsInterval()` 경로에서도 동일한 분기 비용이 발생했다. BootMode 열거형 순서가 고정되어 있으므로 테이블을 통해 바로 조회하면 분기 없이 곧바로 값을 얻어 CPU 분기 비용을 줄일 수 있다.
- **복잡도 영향**: 정적 배열 하나와 경계 체크만 추가되는 수준이며, 기존 분기보다 코드가 더 간결하다.
- **USB 불안정성 영향**: 동일한 인덱스에서 기존과 동일한 값을 반환하므로 HS/FS 전환 시 `bInterval` 값이 바뀌지 않는다. 잘못된 BootMode 값이 들어오는 경우에도 기본값 0x01을 반환하도록 처리해 기존 동작과 동일하게 안전하다.
- **결론**: **채택**.

### 후보 2. 기대 폴링 간격 직접 테이블화
- **성능 영향**: 기존에는 FS 여부를 확인한 뒤 HS 모드에서 `usbBootModeGetHsInterval()`을 호출하고, `1 << (interval-1)` 시프트와 곱셈을 수행했다. BootMode에 따라 기대 간격이 고정되어 있으므로 테이블에서 바로 가져오면 함수 호출과 시프트/곱셈을 제거할 수 있어 ISR 및 폴링 통계 경로의 연산이 줄어든다.
- **복잡도 영향**: BootMode와 동일한 순서를 가진 16비트 테이블을 추가하고 범위만 검사하면 된다. 계산 로직이 없어져 오히려 읽기 쉽다.
- **USB 불안정성 영향**: 기대 간격 값은 기존 계산식과 동일하며, 테이블도 동일한 값을 제공한다. BootMode가 비정상일 때는 기본값(HS 8kHz)을 반환해 이전과 같은 안전장치가 유지된다.
- **결론**: **채택**.

### 후보 3. 샘플 윈도우 캐시 상주화
- **성능 영향**: `usbHidMeasurePollRate()`는 호출마다 `usbBootModeIsFullSpeed()` 결과에 따라 1000/8000을 선택한다. 정적 변수에 캐시하면 대입 연산을 줄일 수 있지만, 모드 변화를 감지하기 위해서는 여전히 동일한 함수를 호출해야 하고, 추가로 상태 비교 로직이 필요하다. 실질적인 연산 절감 폭이 미미하다.
- **복잡도 영향**: 캐시를 도입하면 모드 전환을 감지하기 위한 상태 변수가 필요해 코드가 길어지고, ISR 컨텍스트에서의 동기화 주의 사항도 늘어난다.
- **USB 불안정성 영향**: 잘못된 동기화로 모드 변경 시 샘플 윈도우가 즉시 갱신되지 않으면 통계 지표가 어긋나 탐지 파라미터 분석에 혼선을 줄 수 있다.
- **결론**: **미채택**.

---

## 최종 채택 개선안
- BootMode ↔ HS `bInterval` 매핑을 정적 테이블로 치환해 분기 예측 비용을 제거했다.
- 기대 폴링 간격 계산을 BootMode 전용 테이블 조회로 교체해 함수 호출과 시프트 연산을 없앴다.

## USB 불안정성 탐지 흐름 재검증 메모
1. **BootMode 로딩**: EEPROM에서 불러온 BootMode는 그대로 테이블 인덱스로 사용되어 HS/FS별 `bInterval`과 기대 간격이 즉시 결정된다. 테이블 경계 체크로 예외 모드는 기본값 8kHz를 유지한다.
2. **SOF 모니터 워밍업/감시**: 기대 간격 값은 Prime 이후에도 동일하게 캐시되어 있고, 테이블에서 가져온 값이 `usbHidMonitorSof()`의 패널티 계산에 전달되므로 워밍업·감쇠 로직은 기존과 동일하게 동작한다.
3. **다운그레이드 큐 연동**: `usbRequestBootModeDowngrade()`에 전달되는 기대 간격/누락 프레임은 테이블에서 가져온 값 기반으로 계산되며, 큐 로직과 로그 출력에서 기존과 동일한 수치를 사용한다.
