# MONITOR Review 25 — 후보 개선안 검토 (V251007R6)

## 1. 후보 개선안 목록
1. **워밍업 정상 프레임 직후 데드라인 비교 생략**
2. **USB 부트 모드 변경 시에만 폴링 샘플 윈도우 재계산**
3. **다운그레이드 ARM 상태에서 동일 측정치 재기록 건너뛰기**

## 2. 후보별 검토
### 1) 워밍업 정상 프레임 직후 데드라인 비교 생략
- **성능 영향**: 워밍업 구간의 대부분은 정상 프레임을 연속으로 누적하는 상황이다. 매 프레임마다 데드라인 비교를 수행하면 불필요한 분기 연산이 발생하므로, 카운터가 증가한 프레임에서는 즉시 반환해 분기를 줄이면 ISR 경량화 효과가 있다.
- **복잡도 변화**: 증분 여부를 나타내는 불리언 두 개만 추가하면 되므로 코드 복잡도 증가는 미미하다. 오히려 데드라인 비교가 수행되는 조건이 명확해져 가독성이 향상된다.
- **USB 불안정성 탐지 리스크**: 데드라인 비교는 카운터가 정체되어 있을 때만 필요하므로, 누적에 성공한 프레임에서 비교를 생략해도 워밍업 타임아웃이 지연되지 않는다. 오히려 누적이 진행되지 않는 프레임에서는 기존과 동일하게 즉시 비교하므로 오작동 위험이 없다.
- **결론**: 적용.

### 2) USB 부트 모드 변경 시에만 폴링 샘플 윈도우 재계산
- **성능 영향**: 기존 구현은 매 SOF마다 `usbBootModeIsFullSpeed()`를 호출해 샘플 윈도우를 계산했다. BootMode 변경은 드물기 때문에, 변경이 감지될 때만 샘플 윈도우를 갱신하면 반복 분기와 대입을 줄일 수 있다.
- **복잡도 변화**: 캐시용 정적 변수 두 개가 추가되지만, 샘플 윈도우 결정 로직이 함수 초반에 정리되어 오히려 구조가 단순해진다.
- **USB 불안정성 탐지 리스크**: BootMode가 바뀌면 즉시 캐시를 갱신하므로 샘플 윈도우는 항상 최신 상태를 유지한다. 샘플 윈도우 값 자체는 기존과 동일하여 모니터링 정밀도에는 영향이 없다.
- **결론**: 적용.

### 3) 다운그레이드 ARM 상태에서 동일 측정치 재기록 건너뛰기
- **성능 영향**: 반복된 측정치를 구조체에 다시 기록하지 않으면 메모리 쓰기를 줄일 수 있으나, 이를 위해 매 호출마다 비교가 추가되어 분기 비용이 되레 증가할 가능성이 높다.
- **복잡도 변화**: 측정치 4종(`mode`, `delta_us`, `expected_us`, `missed_frames`)을 모두 비교해야 하므로 코드가 장황해지고, "변경이 있을 때만 기록"이라는 새로운 규칙을 문서화해야 한다.
- **USB 불안정성 탐지 리스크**: 동일 값으로 판단돼 재기록이 건너뛰어질 경우, 실제로는 악화된 측정 결과가 로그에 반영되지 않을 위험이 있다. 분석 정확도가 떨어질 수 있어 모니터 안정성을 해칠 우려가 크다.
- **결론**: 미적용.

## 3. 최종 적용 내역
- 후보 1을 통해 워밍업 정상 프레임에서 즉시 반환하도록 조정해 SOF ISR 분기 수를 줄였다.
- 후보 2를 적용하여 BootMode 변경이 감지될 때만 폴링 샘플 윈도우를 재계산하도록 캐시를 도입했다.
- 위 변경 후 `usbHidMonitorSof()`와 `usbHidMeasurePollRate()` 흐름을 따라가며 USB 불안정성 감시 로직이 의도대로 동작하는지 재검증했다.
