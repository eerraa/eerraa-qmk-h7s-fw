# MONITOR Review 3

## 개선안 후보 및 검토 결과
1. **`usbProcess()`에서 Stage 로컬 캐시 및 필요 경로에서만 `millis()` 호출**
   - 내용: 큐 Stage 값을 로컬 변수에 저장한 뒤, `ARMED` 단계일 때만 `millis()`를 호출하도록 분기한다.
   - (1) 성능 영향: 메인 루프가 `COMMIT` 단계일 때 불필요한 `millis()` 호출을 제거하여 주기당 수 µs 수준의 연산을 줄인다. Stage 로컬 캐시는 분기 예측에도 유리하다.
   - (2) 복잡도: `switch` 진입 전 로컬 변수를 하나 추가하고, `ARMED` case에 지역 변수를 배치하는 정도로 오히려 흐름이 명확해진다.
   - (3) 비정상 작동 가능성: `COMMIT` 단계에서는 시간 비교가 필요 없으므로 기능 변화가 없고, Stage 판정이 로컬 복사로 이뤄져 경쟁 상태도 생기지 않는다.
   → **채택**

2. **워밍업 마감 타임스탬프 로컬 캐시**
   - 내용: `usbHidMonitorSof()`의 워밍업 분기에서 `mon->warmup_deadline_us`를 로컬 변수로 복사한 뒤 비교에 사용한다.
   - (1) 성능 영향: SOF ISR이 구조체 필드를 두 번 읽는 패턴을 한 번으로 줄여 메모리 접근을 절감한다.
   - (2) 복잡도: 읽기용 로컬 변수를 추가하는 것만으로 코드 가독성이 유지된다.
   - (3) 비정상 작동 가능성: 값은 읽기 전용으로 사용하므로 로직에 영향을 주지 않는다.
   → **채택**

3. **`log_pending`과 Stage 비트 통합**
   - 내용: `log_pending`을 Stage 상위 비트에 합쳐 구조체 크기를 줄이는 아이디어.
   - (1) 성능 영향: 비트 마스킹이 필요해져 연산 비용이 늘 가능성이 높다.
   - (2) 복잡도: 상태 해석이 어려워지고, Stage 전환 시 실수 가능성이 커진다.
   - (3) 비정상 작동 가능성: 비트 조작 실수로 로그가 누락되거나 중복될 위험이 커진다.
   → **보류**

4. **누락 프레임 나눗셈을 시프트 연산으로 치환**
   - 내용: `expected_us`가 2의 거듭제곱이라는 가정 하에 나눗셈을 시프트로 대체.
   - (1) 성능 영향: 현재 HS 125µs, FS 1000µs는 2의 거듭제곱이 아니므로 근사 오차가 발생한다.
   - (2) 복잡도: 속도별로 보정 상수를 따로 관리해야 해 오히려 복잡도가 상승한다.
   - (3) 비정상 작동 가능성: 근사 오차로 인해 점수가 축적되지 않거나 과도하게 증가할 수 있다.
   → **기각**

## 최종 반영 요약
- 개선안 1, 2를 반영해 메인 루프와 SOF ISR의 메모리 접근을 줄이고 타이밍 호출을 최소화했다.
- 변경 이후 `usbHidMonitorSof()` → `usbRequestBootModeDowngrade()` → `usbProcess()` 순으로 검증하여 Stage 전환 및 워밍업 마감 비교가 의도대로 동작함을 재확인했다.
