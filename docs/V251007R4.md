# MONITOR Review 23 — 후보 개선안 검토 (V251007R4)

## 1. 후보 개선안 목록
1. **`usbRequestBootModeDowngrade()`에서 0값 측정치를 거르는 가드 추가**
2. **`usbRequestBootModeDowngrade()`가 다운그레이드 큐 포인터와 Stage를 로컬로 캐시**
3. **`usbProcess()` Stage 체인을 `switch-case`로 전환**

## 2. 후보별 검토
### 1) `usbRequestBootModeDowngrade()`에서 0값 측정치를 거르는 가드 추가
- **성능 영향**: `expected_us` 혹은 `missed_frames`가 0으로 전달되면 현재는 Stage를 ARM으로 진입시킨 뒤 곧바로 타임아웃으로 초기화된다. 초기에 입력을 거르면 ARM/COMMIT 분기 전체가 실행되지 않아 불필요한 로그/분기를 제거할 수 있다.
- **복잡도 변화**: 단일 `if` 조건으로 조기 반환시키는 수준이라 코드가 더 간결해진다. 기존 Stage 전환 로직은 그대로 유지된다.
- **USB 불안정성 탐지 리스크**: 정상 경로에서 전달되는 값은 항상 기대 간격(125/250/500/1000µs)과 최소 1프레임 이상으로 보장된다. 0이 입력되는 상황은 버그나 초기화 잔여값뿐이므로 조기 차단이 오히려 안전하다.
- **결론**: 적용.

### 2) `usbRequestBootModeDowngrade()`가 다운그레이드 큐 포인터와 Stage를 로컬로 캐시
- **성능 영향**: 함수 전체에서 `boot_mode_request` 구조체를 여러 번 참조하고 있어 컴파일러가 매번 전역 주소를 다시 계산한다. 로컬 포인터와 Stage 캐시를 사용하면 분기 비교와 구조체 쓰기 시 발생하던 반복 주소 계산이 줄어든다.
- **복잡도 변화**: 포인터/Stage 로컬 변수를 도입하고 기존 `boot_mode_request` 사용 지점을 치환하면 된다. 로직 흐름은 변하지 않는다.
- **USB 불안정성 탐지 리스크**: Stage 값은 함수 진입 시 한 번만 읽고, Stage 전이를 수행할 때는 포인터를 통해 동일 구조체에 기록한다. 캐시와 실데이터가 불일치할 여지가 없어 비정상 동작 위험이 없다.
- **결론**: 적용.

### 3) `usbProcess()` Stage 체인을 `switch-case`로 전환
- **성능 영향**: Stage 값은 0~2 범위라 기존 `if-else` 체인도 분기 예측이 안정적이다. `switch`로 바꿔도 동일한 비교가 생성될 가능성이 높고, jump table이 생길 여지도 적다.
- **복잡도 변화**: `switch`로 옮기면 각 `case`에서 `return` 처리와 로그 플래그 초기화 경로를 다시 구성해야 한다. 가독성과 유지보수성이 오히려 떨어진다.
- **USB 불안정성 탐지 리스크**: Stage 전환 타이밍을 다시 조립하는 과정에서 빠뜨리거나 중복 호출을 만드는 오류 위험이 존재한다. 실익 대비 리스크가 크다.
- **결론**: 미적용.

## 3. 최종 적용 내역
- 후보 1, 2를 채택해 다운그레이드 큐 진입 전에 비정상 측정치를 차단하고, 큐 구조체 접근을 로컬 캐시로 경량화한다.
