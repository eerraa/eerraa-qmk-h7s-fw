# MONITOR Review 10 (V251005R9)

## 개선안 후보 목록
1. 구성 해제 상태에서 SOF 점수(`score`)를 반복 0 기록하지 않고 변경 시에만 초기화한다.
2. 다운그레이드 요청 시 기대 간격·누락 프레임을 ISR에서 16비트로 포화해 그대로 큐에 전달한다.
3. 워밍업 단계에서 임계 초과가 발생하면 즉시 점수를 누적해 다운그레이드를 가속한다.

---

### 후보 1. 구성 해제 상태에서 score 0 재기록 방지
- **요약**: `USBD_STATE_CONFIGURED`가 아닌 루프에서는 이미 0인 `score`를 다시 쓰지 않고, 값이 변할 때만 0으로 초기화한다.
- **성능 영향**: 비구성 구간에서는 매 SOF마다 구조체 쓰기가 제거되어 AHB 버스 접근이 줄어든다. 서스펜드·리셋 중 ISR 부하가 낮아진다.
- **복잡도 영향**: 비교 한 줄만 추가되며, 기존 흐름(타임스탬프 동기화 후 조기 반환)은 동일하다.
- **USB 불안정성 영향**: 구성 해제 상태에서는 모니터가 비활성화되어 점수 값이 의미를 갖지 않는다. 0으로 초기화해야 할 상황(값이 누적된 경우)에는 여전히 0으로 리셋된다. 오동작 위험이 없다.
- **결론**: **채택**.

### 후보 2. 다운그레이드 파라미터 16비트 포화 전달
- **요약**: ISR에서 기대 간격·누락 프레임을 16비트로 포화하고, `usbRequestBootModeDowngrade()`는 이 값을 그대로 받아 저장한다.
- **성능 영향**: ISR 내부에서 이미 계산된 포화 값을 재사용하므로 메인 루프에서 중복된 비교/캐스팅이 제거되고, 함수 호출 인자가 16비트로 축소되어 스택 복사가 줄어든다.
- **복잡도 영향**: 함수 시그니처 변경과 캐스팅 제거 정도로 구조가 단순해진다. 추가 분기는 없다.
- **USB 불안정성 영향**: 누락 프레임은 포화 저장되어도 로깅 시 동일 값을 사용한다. 65535 프레임 이상은 이미 치명적인 상태이므로 포화가 탐지 민감도에 영향을 주지 않는다. 동작 위험이 없다.
- **결론**: **채택**.

### 후보 3. 워밍업 중 임계 초과 시 즉시 점수 누적
- **요약**: 워밍업 단계에서도 안정 임계 초과가 발생하면 감시 점수를 누적해 다운그레이드를 더 빨리 트리거한다.
- **성능 영향**: 워밍업에서 조기 누적을 수행하면 추후 반복 감시가 줄어들 수 있으나, 워밍업 로직 자체는 복잡해진다.
- **복잡도 영향**: 워밍업과 정상 감시 경계를 재구성해야 하고, 워밍업 타임아웃·홀드오프 처리와 상호작용이 늘어나 분기가 많아진다.
- **USB 불안정성 영향**: 워밍업 완료 이전에 다운그레이드 점수를 누적하면 정상적인 초기 지연(케이블 삽입 직후)의 일시적 지터까지 불안정으로 오인할 수 있다. 탐지 로직이 의도한 2048/128 프레임 검증을 우회하므로 오동작 위험이 크다.
- **결론**: **기각** (워밍업 안정성 저하 우려).

---

## 최종 채택 개선안
- 구성 해제 상태에서 SOF 점수를 변경이 있을 때만 0으로 초기화해 불필요한 버스 쓰기를 제거했다.
- 다운그레이드 요청 파라미터를 ISR에서 16비트로 포화한 값으로 전달해 큐 저장 시 중복 산술을 제거하고 스택 복사를 줄였다.

## USB 불안정성 탐지 흐름 재검증 메모
1. **상태 전환/비구성 루프**: `usbHidMonitorSof()`가 비구성 상태에서 `score`가 0인지 확인한 뒤에만 초기화하므로, 구성 복귀 전에 잔여 점수가 있으면 정상적으로 리셋되고 추가 쓰기는 발생하지 않는다.
2. **서스펜드/리줌**: 서스펜드 진입 시 Prime 로직이 그대로 실행되어 워밍업·홀드오프 타이머가 초기화된다. 리줌 이후 첫 SOF에서도 변경된 guard가 적용되어 점수 초기화가 중복되지 않는다.
3. **워밍업/안정 감시**: 워밍업 조건, 감쇠 로직, 누락 프레임 산출 경로는 변경되지 않았다. `missed_frames_report`만 추가되어도 패널티 계산은 기존 32비트 값을 그대로 사용한다.
4. **다운그레이드 큐 연동**: `usbRequestBootModeDowngrade()`가 16비트 파라미터를 받아 즉시 저장하므로, ARM/COMMIT 단계에서 재포화 연산이 제거되었다. `usbBootModeRequestMissedFrames()`는 여전히 같은 16비트 캐시를 사용해 로그를 출력한다.
5. **메인 루프 처리**: Stage 전환, 타임아웃 비교, 리셋 흐름은 변경되지 않았다. 새 시그니처는 ISR과 메인 루프 간 데이터 형식을 명확히 하여 안정성 로직과 일치한다.
