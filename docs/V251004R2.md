# MONITOR Review 2

## 개선안 후보 및 검토 결과
1. **SOF 페널티 계산식 단순화**  
   - 내용: `delta_us`에서 `expected_us`를 직접 차감한 뒤 정수 나눗셈을 수행하여 누락 프레임 수를 계산하고, 별도의 올림 처리를 제거한다.  
   - (1) 성능 영향: ISR 내 산술 연산 횟수가 줄어들어 약간의 사이클을 절감할 수 있다. 정수 나눗셈은 동일하게 유지되지만, 덧셈과 보정 연산이 빠지므로 긍정적이다.  
   - (2) 복잡도: 계산식이 짧아져 이해가 더 쉬워진다. 음수 가능성을 워밍업 임계치 분기로 이미 차단하고 있으므로 추가 분기 없이 유지 가능하다.  
   - (3) 비정상 작동 가능성: 워밍업 이후 경로에서만 호출되며 `delta_us >= expected_us`가 항상 보장된다. 기존 대비 동치가 유지되므로 위험 낮음.  
   → **채택**

2. **다운그레이드 큐에 누락 프레임 수 캐시**  
   - 내용: `usb_boot_mode_request_t`에 `missed_frames`를 추가하여 로그 시 재계산을 피하고, ISR에서 산출한 값을 그대로 사용한다.  
   - (1) 성능 영향: 로그 시 반복적으로 수행하던 나눗셈을 제거할 수 있어 메인 루프 오버헤드 감소. ISR에서 이미 계산한 값을 재사용하므로 긍정적.  
   - (2) 복잡도: 필드 하나와 초기화 코드만 추가되며, 로직은 오히려 단순화된다.  
   - (3) 비정상 작동 가능성: 초기화 누락 시 0이 반환될 수 있으나, 요청 큐 리셋 단계에서 함께 초기화하면 문제 없음.  
   → **채택**

3. **워밍업 체크를 비트마스크 플래그로 통합**  
   - 내용: `warmup_complete`와 `suspended_active`를 비트마스크 하나로 합쳐 구조체 크기를 줄이는 아이디어.  
   - (1) 성능 영향: 비트 연산 변환 비용이 증가하고, 현재 구조체가 이미 캐시 친화적으로 정렬돼 있어 개선폭이 미미하다.  
   - (2) 복잡도: 각 플래그 의미가 불분명해져 가독성이 저하된다. 유지보수 난이도 상승 우려.  
   - (3) 비정상 작동 가능성: 비트 조작 실수로 서스펜드/워밍업 상태가 꼬일 수 있어 위험이 상대적으로 크다.  
   → **보류**

## 최종 반영 요약
- 개선안 1과 2를 구현하여 ISR 경량화와 로그 경로 최적화를 동시에 달성하였다.
- 변경 이후 `usbHidMonitorSof()` → `usbRequestBootModeDowngrade()` → `usbProcess()` 흐름을 따라가며, 누락 프레임 수가 일관되게 전달되고 있는지 재검증하였다.
