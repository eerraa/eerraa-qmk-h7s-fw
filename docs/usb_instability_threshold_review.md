# USB 불안정성 점수 기준 재검토 (V251005R5)

## 1. 현행 점수 체계 요약
- HS/FS 공통으로 SOF 간격이 안정 기준을 넘으면 `missed_frames - 1` 만큼 점수를 누적하고, 이벤트 당 최대치는 `USB_SOF_MONITOR_SCORE_CAP`으로 제한됩니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L492-L498】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1529-L1535】
- HS 모드는 기대 간격 125µs, 정상 허용치 250µs, 점수 감쇠 주기는 4ms, 다운그레이드 임계점은 12점입니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L520-L533】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1503-L1524】
- FS 모드는 기대 간격 1ms, 정상 허용치 2ms, 점수 감쇠 주기는 20ms, 다운그레이드 임계점은 6점입니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L520-L533】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1503-L1524】

## 2. 시나리오 구성
현행 로직이 대응하는 패턴과 놓치는 패턴을 구분하기 위해 HS/FS별로 임계 도달 사례와 미도달 사례를 추가로 정리했습니다. 감쇠 타이밍이 점수 누적에 어떤 영향을 주는지 확인할 수 있도록 이벤트 간격과 감쇠 횟수를 함께 명시합니다.

### 2.1 HS 모드 (감쇠 주기 4ms, 임계점 12점)
| 구분 | SOF 간격 지연 | 계산된 `missed_frames` | 1회 패널티 | 이벤트 간격 | 감쇠 영향 | 점수 진행 | 임계 도달 여부 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| S1 | 1.00ms (8프레임 누락) | 8 | +7 (상한 적용) | 연속 2회, 10ms 이내 | 두 번째 이벤트 전까지 2회 감쇠(−2) | 7 → 5 → 12 | **도달** |
| S2 | 0.50ms (4프레임 누락) | 4 | +3 | 5ms 간격 3회 | 각 간격에서 1회 감쇠(−1) | 3 → 2 → 5 → 4 → 7 → 6 → 9 | 미도달 |
| S3 | 0.38ms (3프레임 누락) | 3 | +2 | 4ms 간격 6회 | 감쇠 주기와 동일, 매 회 직전 −1 | (2 − 1) × 6 = 6 | 미도달 |
| S4 | 0.75ms (6프레임 누락) | 6 | +5 | 12ms 간격 3회 | 사이에 3회 감쇠(−3) | 5 → 2 → 7 → 4 → 9 | 미도달 |
| S5 | 1.00ms 누락이 30ms마다 반복 | 8 | +7 | 30ms 간격 | 사이에 7회 감쇠(−7) | 0 ↔ 7 반복 | 미도달 |
| S6 | 0.25ms (2프레임 누락) 반복 + 간헐적 0.75ms 누락 | 2 / 6 | +1 / +5 | 3ms 간격으로 0.25ms 누락 6회, 직후 0.75ms 누락 | 0.25ms 구간에서 두 차례 감쇠(−2) | (1×6 − 2) + 5 = 9 | 미도달 |

### 2.2 FS 모드 (감쇠 주기 20ms, 임계점 6점)
| 구분 | SOF 간격 지연 | `missed_frames` | 1회 패널티 | 이벤트 간격 | 감쇠 영향 | 점수 진행 | 임계 도달 여부 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| F1 | 2.00ms (2프레임 누락) | 2 | +1 | 5ms 간격 8회 | 감쇠 주기보다 짧아 4회마다 −1 | 1씩 누적, 8회차 8 → 상한 7 | **도달** |
| F2 | 4.00ms (4프레임 누락) | 4 | +3 | 40ms 간격 | 사이에 2회 감쇠(−2) | 3 → 1 → 2 → 0 반복 | 미도달 |
| F3 | 6.00ms (6프레임 누락) | 6 | +5 | 25ms 간격 | 사이에 1회 감쇠(−1) | 5 → 4 → 9 (상한 7) | **도달** |
| F4 | 2.00ms 누락이 60ms마다 반복 | 2 | +1 | 60ms 간격 | 사이에 3회 감쇠(−3) | 0 ↔ 1 반복 | 미도달 |
| F5 | 1.00ms 간헐 지연 후 즉시 회복 | 1 (패널티 없음) | 0 | 단발성 | 감쇠 없음 | 0 유지 | 미도달 |

### 2.3 장주기 누락 가정 분석
- HS 50ms, FS 80ms 이상의 긴 주기로 반복되는 누락은 감쇠 주기(각각 4ms, 20ms) 동안 여러 차례 점수가 감소하여 임계에 도달하지 않습니다. 이는 사용자가 체감하는 연속 입력 손실보다는 EMI 또는 허브 전환 시 발생하는 산발적 지연에 가깝습니다.
- 위 표의 S4/S5, F2/F4는 실제로는 하위 계층(허브/케이블) 문제 로그 확보용으로 분류되며, 임계에 도달하지 않아도 누락 프레임 수가 `usbRequestBootModeDowngrade()` 요청 경로를 통해 로그에 남습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1525-L1564】【F:src/hw/driver/usb/usb.c†L220-L304】

## 3. 임계·감쇠 파라미터 적정성 평가
1. **임계점(HS 12점, FS 6점)**: SOF 패널티가 `missed_frames - 1`로 환산되어 상한 7점까지 누적되고, 임계 초과 시 즉시 다운그레이드 요청을 생성합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L492-L535】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1503-L1564】 HS에서 연속 두 차례의 대규모 누락(S1) 또는 FS에서 반복 지연(F1/F3)은 곧바로 임계에 도달하여 고속 모드 유지가 어려운 상황을 빠르게 감지합니다.
2. **감쇠 주기(HS 4ms, FS 20ms)**: 감쇠는 연속 프레임 손실에 집중하도록 설계되었습니다. USB 2.0 규격 Chapter 8과 ST RM0481 USB OTG HS/FS 절에서는 연속적인 프레임/마이크로프레임 손실을 주요 오류로 규정하며, 단발성 지연은 호스트 재전송이나 회복 절차에 맡기는 것을 전제로 합니다. 장주기 누락을 모두 임계로 만들 경우 HS 우선 정책과 상충하여 false downgrade 가능성이 커집니다.
3. **감쇠 주기 조정 필요성**: 필드 로그에서 장주기 누락이 반복적으로 나타난다면 HS 감쇠 주기를 6~8ms, FS 감쇠 주기를 25~30ms로 완화하거나 임계값을 각 1~2점 낮추는 방안을 고려할 수 있습니다. 다만 S2/S3/F2와 같은 경미한 지연에도 임계에 근접하게 되어 사용자가 체감하지 못한 상황에서 속도가 강등될 위험이 있으므로, 변경 전 실측 데이터 확보가 선행되어야 합니다.

## 4. FS 모드에서의 모니터 지속 필요성
- FS 모드에는 추가 다운그레이드 단계가 없지만, 모니터는 다음과 같은 이유로 유지 가치가 있습니다.
  - 다운그레이드 실패 또는 FS 유지 중 누락이 발생하면 `USB_SOF_MONITOR_RECOVERY_DELAY_US`와 `USB_BOOT_MONITOR_CONFIRM_DELAY_US`를 재설정하여 재시도 시점을 제어합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L488-L507】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1525-L1564】
  - `missed_frames`와 SOF 간격이 로그로 남아 호스트·케이블 문제를 역추적할 수 있습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1525-L1564】【F:src/hw/driver/usb/usb.c†L220-L304】
  - FS 환경에서도 SOF ISR 오버헤드는 상수 시간 연산으로 유지되며, 1kHz 호출에서도 시스템 부하가 미미합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1361-L1564】
- 따라서 FS 모드에서도 모니터를 비활성화하기보다는, 필요 시 경고 LED·호스트 로그 등 사용자 통지 수단을 보완하는 것이 합리적입니다.

## 5. 결론 및 권장 사항
1. **임계·감쇠 유지**: 연속 또는 단주기 누락을 신속히 탐지하는 목적에는 현재 값(HS: 12점, 4ms / FS: 6점, 20ms)이 적절합니다. 장주기 패턴까지 포착하려면 감쇠 주기 완화나 임계 하향이 필요하지만, 이는 false downgrade 위험을 증가시킵니다.
2. **필드 데이터 수집**: 장주기 누락(S4/S5, F2/F4 유형)의 발생 빈도를 로깅으로 확보한 뒤 필요 시 파라미터 재조정을 검토합니다. FS 모드에서도 점수와 누락 프레임 기록을 유지하여 호스트 품질 분석에 활용해야 합니다.
3. **외부 근거 참조**: STM32H7S RM0481 USB OTG HS/FS 장과 USB 2.0 Rev.2.0 Chapter 8에서 제시하는 프레임/마이크로프레임 허용 오차 및 오류 처리 방식을 지속적으로 확인하여, 연속 손실 탐지에 초점을 둔 현행 점수 체계를 유지합니다.
