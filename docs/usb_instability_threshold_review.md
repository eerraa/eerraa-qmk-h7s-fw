# USB 불안정성 점수 기준 재검토 (V251005R4)

## 1. 현행 점수 체계 요약
- HS/FS 공통으로 SOF 간격이 안정 기준을 넘으면 `missed_frames - 1` 만큼 점수를 누적하고, 이벤트 당 최대치는 `USB_SOF_MONITOR_SCORE_CAP`으로 제한됩니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L492-L498】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1529-L1535】
- HS 모드는 기대 간격 125µs, 정상 허용치 250µs, 점수 감쇠 주기는 4ms, 다운그레이드 임계점은 12점입니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L520-L533】
- FS 모드는 기대 간격 1ms, 정상 허용치 2ms, 점수 감쇠 주기는 20ms, 다운그레이드 임계점은 6점입니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L520-L533】

## 2. 외부 근거 정리
- STMicroelectronics STM32H7S 레퍼런스 매뉴얼(RM0481) USB OTG HS 장은 HS 모드에서 125µs 마이크로프레임, FS 모드에서 1ms 프레임을 지속적으로 발행한다고 명시합니다. 즉, 두 마이크로프레임 이상이 연속으로 누락되면 PHY 측에서 비정상 상황으로 간주할 수 있습니다.
- USB 2.0 규격(Rev. 2.0, Chapter 8) 역시 HS 마이크로프레임을 125µs로 정의하고, 스케줄러가 마이크로프레임 단위로 등간격 전송을 보장해야 한다고 규정합니다. 이 때문에 8개(1ms 상당)의 마이크로프레임이 연속으로 누락되는 경우는 심각한 스케줄링 실패 시나리오로 해석됩니다.

## 3. 기존 설정의 한계
- 이전 `USB_SOF_MONITOR_SCORE_CAP=3`에서는 1ms(8마이크로프레임) 이상 지연이 발생해도 점수가 최대 3점만 누적되었습니다. HS 모드의 다운그레이드 임계점이 12점이므로 동일한 1ms 지연이 네 번 반복되어야만 하위 폴링 모드 요청이 가능했습니다. 이는 실제로는 단 한 번의 대규모 지연만으로도 입력 끊김이 체감되는 상황을 반영하지 못합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L492-L498】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1529-L1564】
- 점수 감쇠 주기가 4ms이기 때문에, 1ms 지연이 간헐적으로 반복되면 누적 점수가 감쇠되어 임계점 도달이 더욱 어려워집니다. 결과적으로 고속 모드 유지에 집착하면서 실제 사용자는 반복적인 입력 드롭을 경험할 수 있습니다.

## 4. 조정 사항과 기대 효과
- 이벤트 당 최대 누적치를 7점으로 확장하여(8마이크로프레임 누락 시 계산 결과와 동일) 대규모 지연의 심각도를 그대로 반영하도록 수정했습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L492-L498】
- 이제 1ms 지연이 두 번 연속 발생하면 누적 점수가 14점까지 상승하여 즉시 다운그레이드 큐에 진입합니다. 이는 USB 2.0 규격에서 정의한 마이크로프레임 스케줄 보장 기준과 일치하는 수준의 민감도로, 실제 입력 손실을 더 빠르게 복구하도록 유도합니다.
- 소규모 지터(예: 250µs 수준)는 여전히 1점만 부과되고, 감쇠 주기(4ms)가 유지되므로 정상 호스트 환경에서는 false positive 가능성이 높지 않습니다.

## 5. 향후 관찰 포인트
- 점수 상한이 커진 만큼, 다운그레이드 이후의 복구 시간(현재 50ms)을 유지하면서도 false downgrade 발생 여부를 필드 로그로 수집해야 합니다.
- FS 모드에서는 추가 다운그레이드 경로가 없으므로, 추후 FS 안정화 로직과 연계해 점수 상한을 속도별로 분리하는 개선을 검토할 수 있습니다.
