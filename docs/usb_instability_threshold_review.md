# USB 불안정성 점수 기준 재검토 (V251005R4)

## 1. 현행 점수 체계 요약
- HS/FS 공통으로 SOF 간격이 안정 기준을 넘으면 `missed_frames - 1` 만큼 점수를 누적하고, 이벤트 당 최대치는 `USB_SOF_MONITOR_SCORE_CAP`으로 제한됩니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L492-L498】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1529-L1535】
- HS 모드는 기대 간격 125µs, 정상 허용치 250µs, 점수 감쇠 주기는 4ms, 다운그레이드 임계점은 12점입니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L520-L533】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1503-L1524】
- FS 모드는 기대 간격 1ms, 정상 허용치 2ms, 점수 감쇠 주기는 20ms, 다운그레이드 임계점은 6점입니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L520-L533】【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1503-L1524】

## 2. 시나리오 구성
### 2.1 HS 모드 (감쇠 주기 4ms, 임계점 12점)
| 구분 | SOF 간격 지연 | 계산된 `missed_frames` | 1회 패널티 | 이벤트 간격 | 감쇠 영향 | 임계 도달 여부 |
| --- | --- | --- | --- | --- | --- | --- |
| S1 | 1.00ms (8프레임 누락) | 8 | +7 (상한 적용) | 연속 2회, 10ms 이내 | 두 번째 이벤트 전까지 2회 감쇠(−2) | 7 → 5 → 12로 즉시 도달 |
| S2 | 0.50ms (4프레임 누락) | 4 | +3 | 5ms 간격으로 3회 | 각 간격에서 1회 감쇠(−1) | 3 → 2 → 5 → 4 → 7 → 6 → 9 (미도달) |
| S3 | 0.38ms (3프레임 누락) | 3 | +2 | 4ms 간격으로 6회 | 감쇠 주기와 동일하여 이벤트 직전에 −1 | 누적이 2·(6) − 6 = 6 (미도달) |
| S4 | 1.00ms 누락이 30ms마다 반복 | 8 | +7 | 30ms 간격 | 사이에 7회 감쇠(−7) | 항상 0~7 범위, 임계 미도달 |
| S5 | 0.75ms 누락 후 즉시 정상 | 6 | +5 | 단발성 | 다음 프레임부터 감쇠 진행 | 5 → 4 → … → 0, 임계 미도달 |

### 2.2 FS 모드 (감쇠 주기 20ms, 임계점 6점)
| 구분 | SOF 간격 지연 | `missed_frames` | 1회 패널티 | 이벤트 간격 | 감쇠 영향 | 임계 도달 여부 |
| --- | --- | --- | --- | --- | --- | --- |
| F1 | 2.00ms (2프레임 누락) | 2 | +1 | 5ms 간격 8회 | 감쇠 주기보다 짧아 4회 후 −1 | 1씩 누적되어 8회차에 8 → 상한 7 → 임계 초과 |
| F2 | 4.00ms (4프레임 누락) | 4 | +3 | 40ms 간격 | 사이에 2회 감쇠(−2) | 3 → 1 → 2 → 0 반복, 임계 미도달 |
| F3 | 6.00ms (6프레임 누락) | 6 | +5 | 25ms 간격 | 사이에 1회 감쇠(−1) | 5 → 4 → 9 (상한 7) → 임계 초과 |

## 3. 임계·감쇠 파라미터 적정성 평가
1. **임계점(HS 12점, FS 6점)**: S1/F1/F3처럼 두 차례 이상의 대규모 누락이 짧은 간격으로 반복되면 즉시 임계점을 초과해 다운그레이드 큐가 동작합니다. 이는 USB 2.0 규격에서 정의한 마이크로프레임 스케줄 보장(HS 125µs, FS 1ms)에 비추어볼 때 실제 데이터 드롭이 체감되는 수준의 이상 상황을 빠르게 포착하는 데 충분합니다.
2. **감쇠 주기(HS 4ms, FS 20ms)**: S3, S4, F2처럼 장주기로 반복되는 누락 패턴에서는 감쇠가 누적 점수를 초기화하여 임계에 도달하지 않습니다. 30ms 주기의 HS 누락(S4)과 40ms 주기의 FS 누락(F2)은 각각 33Hz, 25Hz 수준의 간헐적 손실이며, USB 호스트 스케줄러의 정규 주기(8kHz/1kHz) 대비 매우 드문 이벤트로 분류됩니다. ST RM0481 및 USB 2.0 규격에서는 PHY 또는 호스트가 포트 상태를 재협상하거나 회복 절차를 가동할 수 있도록 연속적인 프레임 손실을 주요 오류 조건으로 다루므로, 현행 감쇠 설정이 "연속적인" 문제에 집중하는 설계 의도와 부합합니다.
3. **감쇠 주기 조정 필요성**: 장주기 누락이 사용성에 영향을 줄 만큼 빈번하다면 HS 감쇠를 6~8ms로 완화하거나 임계값을 10~11점으로 낮추는 방안을 검토할 수 있습니다. 다만 이렇게 되면 S2/S3 같이 단발성 또는 경미한 지연에도 다운그레이드가 촉발될 수 있어, 상위 모드 유지 정책(HS 우선)에 맞지 않을 수 있습니다. 실제 필드 로그에서 20ms 이상 간격의 누락이 반복된 사례가 없다면 현행 유지가 합리적입니다.

## 4. FS 모드에서의 모니터 지속 필요성
- FS 모드에는 추가 다운그레이드가 존재하지 않지만, 모니터는 다음과 같은 역할을 수행합니다.
  - 다운그레이드 시도 실패 후 `USB_SOF_MONITOR_RECOVERY_DELAY_US`를 적용하여 재시도 간격을 제어합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1546-L1564】
  - 누락 프레임 수를 로그 및 진단 데이터로 남겨 host 측 문제(허브, 케이블, EMI 등)를 추적할 수 있게 합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1537-L1564】【F:src/hw/driver/usb/usb.c†L268-L303】
- 따라서 FS 모드에서도 모니터를 비활성화하기보다는, 필요 시 FS 전용 알림(예: 경고 LED 또는 호스트 로그)을 추가하여 사용자에게 지속적 이상을 통지하는 방향이 바람직합니다. 모니터의 연산량은 SOF 인터럽트당 상수 시간이며, FS 1kHz 환경에서도 큰 오버헤드가 발생하지 않습니다.

## 5. 결론 및 권장 사항
1. **임계·감쇠 유지**: 연속 또는 단주기 누락을 신속히 탐지하는 목적에는 현재 값(HS: 12점, 4ms / FS: 6점, 20ms)이 적절합니다. 장주기 패턴까지 포착하려면 감쇠 주기 연장을 고려해야 하지만, 이는 false downgrade 위험을 높입니다.
2. **필드 데이터 수집**: 장주기 누락(S4, F2 유형)의 실측 빈도를 로깅으로 확보한 뒤 필요 시 파라미터 재조정 여부를 결정합니다. FS 모드에서도 점수와 누락 프레임 수를 유지해 호스트 품질 분석에 활용해야 합니다.
3. **외부 근거**: STM32H7S RM0481의 USB OTG HS/FS 타이밍 규격과 USB 2.0 Rev.2.0 Chapter 8의 프레임 규격을 지속적으로 참조하여, 점수 체계가 규격상 정의된 오류 조건(연속 프레임 누락)에 대응하도록 유지합니다.
