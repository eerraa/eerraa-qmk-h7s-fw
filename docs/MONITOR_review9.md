# MONITOR Review 9 (V251005R8)

## 개선안 후보 목록
1. 동일 속도로 Prime이 호출될 때 `usbHidSofMonitorApplySpeedParams()` 재호출을 생략해 구조체 쓰기를 줄인다.
2. 다운그레이드 점수 계산을 누락 패널티의 단일 덧셈/비교로 단순화해 분기 수를 줄인다.
3. 서스펜드 진입 시 Prime 대신 `usbHidSofMonitorSyncTick()`만 호출하도록 조정해 초기화 비용을 더 줄인다.

---

### 후보 1. 동일 속도 Prime 시 속도 파라미터 재적용 생략
- **요약**: Prime 내부에서 이전에 적용한 속도 캐시가 그대로 유효하면 파라미터 복사를 건너뛰어 중복 메모리 접근을 제거한다.
- **성능 영향**: 서스펜드↔리줌, 구성 재 Prime 시 5개의 16비트 필드 쓰기를 피할 수 있어 ISR 전·후 처리 경로의 버스 사용량이 감소한다.
- **복잡도 영향**: 조건 분기 한 줄만 추가되며, 기존 Prime 경로와 호출 흐름은 동일하게 유지된다.
- **USB 불안정성 영향**: 유효 속도(`expected_us != 0`)에서만 재사용하므로, 초기화나 속도 전환처럼 캐시가 비어 있는 경우에는 그대로 재적용된다. 오동작 가능성이 없다.
- **결론**: **채택**.

### 후보 2. 다운그레이드 점수 누적 단순화
- **요약**: 남은 임계 예산을 별도로 계산하지 않고 `score + penalty`가 임계치를 넘는지를 바로 비교해 분기와 산술을 줄인다.
- **성능 영향**: 8비트 덧셈과 비교 한 번으로 판단이 끝나 이전의 `budget` 계산·분기보다 짧은 실행 경로를 제공한다.
- **복잡도 영향**: 코드가 `score`와 `penalty`의 관계로만 표현되어 읽기 쉽고 유지보수 부담이 낮다.
- **USB 불안정성 영향**: 기존 로직과 동일하게 `score >= threshold` 또는 `score + penalty >= threshold`에서만 다운그레이드를 트리거하며, 패널티가 작을 때는 누적만 수행한다. 행동 변화가 없다.
- **결론**: **채택**.

### 후보 3. 서스펜드 Prime 생략 시나리오
- **요약**: 서스펜드 진입 시 Prime 호출을 생략하고 `usbHidSofMonitorSyncTick()`만 호출해 점수 초기화만 수행한다.
- **성능 영향**: Prime 호출을 피할 수 있어 미세한 초기화 비용 절감이 예상된다.
- **복잡도 영향**: 서스펜드 플래그 처리와 점수 초기화 순서를 재조정해야 하므로 분기가 증가한다.
- **USB 불안정성 영향**: Prime을 건너뛰면 `warmup_deadline`과 `holdoff_end` 갱신이 이루어지지 않아, 리줌 직후 워밍업 타이머가 이미 만료된 값으로 남을 위험이 있다.
- **결론**: **기각** (안정성 저하 우려).

---

## 최종 채택 개선안
- 동일 속도로 반복 Prime이 들어오는 경우 캐시된 속도 파라미터를 재사용해 메모리 쓰기를 줄였다.
- 다운그레이드 점수 계산을 단일 덧셈/비교로 정리해 분기를 줄이고 ISR 경로를 단순화했다.

## USB 불안정성 탐지 흐름 재검증 메모
1. **상태 전환/서스펜드**: Prime 호출 시 새로 추가된 캐시 재사용 조건이 `expected_us`가 0이 아닐 때만 동작하므로, 초기 구성이나 속도 전환에서는 항상 `usbHidSofMonitorApplySpeedParams()`가 실행된다.
2. **워밍업**: Prime이 캐시를 재사용하더라도 워밍업 카운터·마감 타임스탬프는 여전히 재설정되며, 홀드오프 구간에서는 기존과 동일하게 `usbHidSofMonitorSyncTick()`만 호출된다.
3. **안정 감시**: 누락 프레임 계산 이후 `score + penalty` 비교가 기존 `budget` 비교와 동일한 결과를 반환함을 확인했다. 패널티가 남은 예산보다 작을 때만 점수를 누적한다.
4. **다운그레이드 큐 연동**: 다운그레이드가 발생하면 `usbRequestBootModeDowngrade()`에 전달하는 파라미터(누락 프레임·delta)는 변함이 없으며, 홀드오프 타이머와 점수 초기화가 기존과 동일하게 진행된다.
5. **메인 루프 처리**: 큐 구조나 Stage 흐름에 변경이 없어 `usbProcess()`의 행동은 기존과 동일하다. Prime 최적화는 ISR 내부에 국한되어 메인 루프와의 인터페이스가 유지된다.
