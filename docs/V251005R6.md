# MONITOR Review 7 (V251005R6)

## 개선안 후보 목록
1. `usbHidSofMonitorPrime()`에서 속도 파라미터 필드를 0으로 재설정하지 않고, `usbHidSofMonitorApplySpeedParams()`가 직접 값을 채우도록 경량화한다.
2. 누락 프레임 계산을 USB 속도별 상수 나눗셈으로 분기하는 `usbCalcMissedFrames()` 인라인 도우미를 추가하여 ISR과 다운그레이드 큐의 중복 계산을 축소한다.
3. 이미 동일 속도로 Prime이 호출될 때 워밍업/점수 상태를 유지한 채 `usbHidSofMonitorPrime()`을 생략하는 최적화 경로를 도입한다.

---

### 후보 1. Prime 단계의 속도 파라미터 중복 초기화 제거
- **요약**: Prime 시점에서 `expected_us` 등 파라미터를 0으로 초기화하지 않고, 속도 파라미터 적용 함수가 직접 값을 기록하도록 변경.
- **성능 영향**: 초기화 시 불필요한 메모리 쓰기가 제거되어 SOF 상태 전환 시 ISR 오버헤드가 소폭 감소한다. 워밍업·홀드오프 로직에는 영향이 없다.
- **복잡도 영향**: 제어 흐름은 기존과 동일하며, 파라미터 적용 위치만 명확히 분리된다. 코드 이해도 상승.
- **USB 불안정성 영향**: 속도 코드가 알려지지 않은 경우 `usbHidSofMonitorApplySpeedParams()`에서 여전히 0으로 초기화하므로 오동작 위험이 없다.
- **결론**: **채택**.

### 후보 2. 속도별 상수 나눗셈 기반 누락 프레임 계산 도우미 추가
- **요약**: `usbCalcMissedFrames()` 인라인 함수를 도입해 HS(125/250/500µs)와 FS(1000µs) 구간을 상수 나눗셈으로 처리하고, 미지원 값은 기존 분기 유지.
- **성능 영향**: 변수 나눗셈보다 상수 나눗셈으로 컴파일러 최적화가 쉬워져 ISR 연산량이 감소한다. 다운그레이드 큐에서도 동일 혜택을 공유.
- **복잡도 영향**: 단일 함수로 계산 경로가 통합되어 중복이 사라지고 유지보수가 용이하다.
- **USB 불안정성 영향**: 기존과 동일한 정수 나눗셈을 수행하며, 미지원 간격에는 기존 분기를 사용하므로 탐지 로직과 임계값에 변화가 없다.
- **결론**: **채택**.

### 후보 3. 동일 속도 Prime 생략 경로 추가
- **요약**: Prime 호출 시 현재 `active_speed`와 동일하고 홀드오프·워밍업 지연이 0이면 구조체 초기화를 생략한다.
- **성능 영향**: Prime 호출 빈도가 낮아 체감 이득이 제한적이다.
- **복잡도 영향**: Prime 재진입 조건과 상태 보존 로직이 추가되어 유지보수가 어려워진다.
- **USB 불안정성 영향**: 서스펜드/리스타트 직후 이전 상태가 남아 있을 가능성이 생겨, 워밍업 카운터와 점수 리셋이 누락될 우려가 있다.
- **결론**: **보류** (비선택).

---

## 최종 채택 개선안
- Prime 단계에서 속도 파라미터 초기화 책임을 `usbHidSofMonitorApplySpeedParams()`로 집약하여, SOF 상태 전환 시 불필요한 쓰기를 제거했다.
- `usbCalcMissedFrames()`를 추가하여 ISR과 다운그레이드 큐가 동일한, 상수 분기 기반 누락 프레임 계산을 재사용하도록 했다.

## USB 불안정성 탐지 흐름 재검증 메모
1. **상태 전환**: USB Configure/Resume 시 Prime이 호출되며, 타임스탬프·점수·워밍업 카운터가 초기화되고 속도 파라미터는 `usbHidSofMonitorApplySpeedParams()`에서 일괄 반영된다.
2. **홀드오프/워밍업**: SOF ISR은 홀드오프 종료 전 `usbHidSofMonitorSyncTick()`만 수행하며, 워밍업 카운터는 값이 변경될 때만 구조체에 반영된다.
3. **안정 감시**: 워밍업 완료 후 `delta_us`를 측정하고, `usbCalcMissedFrames()`가 상수 나눗셈으로 누락 프레임을 구한 뒤 패널티·임계 비교를 진행한다.
4. **다운그레이드 큐 연동**: 임계 초과 시 `usbRequestBootModeDowngrade()`로 `delta_us`, `expected_us`, `missed_frames`를 전달하며, 큐는 동일 도우미를 통해 로그 시 재계산 부담 없이 값을 유지한다.
5. **메인 루프 처리**: `usbProcess()`는 Stage 캐시 로직이 유지되어, ARM 상태에서만 `millis()`를 호출하고 COMMIT 단계에서 BootMode 저장 후 리셋을 수행한다.

위 흐름 점검 결과, 수정된 경량화가 USB 불안정성 탐지 동작에 영향을 주지 않음을 확인했다.
