# 호스트 LED 비동기화 완성 계획 (V251010R3 제안)

## 1. 목표
- USB HID `SET_REPORT` 처리 경로에서 인터럽트 컨텍스트를 즉시 반환시키고, Caps Lock 등 호스트 LED 반영을 메인 루프와 WS2812 서비스 경로로 완전히 이관합니다.
- LED 상태 동기화 지연을 1 프레임(최대 1ms @HS 1kHz) 이내로 제한하여 사용자 체감과 호스트 피드백 간 불일치를 제거합니다.
- UART 로그 및 모니터링 경로가 LED 비동기화 흐름을 방해하지 않도록 비블로킹화를 병행합니다.

## 2. 구현 단계

### 2.1 ISR 최소화
1. `USBD_HID_EP0_RxReady()`에서 `usbHidSetStatusLed()` 직접 호출을 제거하고, 마지막으로 수신한 LED 비트를 보관하는 전역 상태 버퍼(예: `volatile uint8_t g_host_led_bits`).
2. ISR는 상태 버퍼 업데이트 후 `usbHidRequestStatusLedSync()`와 같은 플래그 세터만 호출하고 즉시 복귀합니다.
3. 동기식 UART 로그는 `HW_USB_LOG` 매크로 또는 비동기 큐를 통해 우회하고, 기본 빌드에서는 비활성화합니다.

### 2.2 메인 루프 후처리
1. `usbHidUpdate()` 혹은 `keyboard_task()` 말미에 `usbHidServiceStatusLed()` 진입점을 추가하여, 플래그가 세트된 경우 `usbHidSetStatusLed()`를 호출하도록 구성합니다.
2. WS2812 DMA 비동기 큐(`ws2812RequestRefresh()` → `ws2812ServicePending()`)와 결합하여, Caps Lock LED 반영 시에도 기존 RGB 프레임워크를 재사용합니다.
3. 메인 루프 호출 간 LED 상태가 누락되지 않도록, 마지막으로 처리한 호스트 LED 비트를 저장해 중복 요청을 필터링합니다.

### 2.3 경계 조건 처리
1. USB가 언플러그된 경우에도 마지막 LED 상태를 유지해야 하므로, `usbHidReset()` 및 `usbHidSuspend()` 경로에서 상태 버퍼를 초기화합니다.
2. 호스트가 빠르게 LED 토글을 반복할 때 ISR 큐가 덮어쓰이지 않도록, 필요 시 1바이트 링 버퍼 또는 타임스탬프 비교를 사용합니다.
3. USB instability monitor 로그는 LED 처리 플로우와 분리된 비동기 출력(예: ITM/SWO 또는 DMA 기반 UART)으로 재배치합니다.

## 3. 검증 계획
- **USB 마이크로프레임 모니터링**: Caps Lock 토글 직후 SOF 공백이 1마이크로프레임 이하인지 확인합니다.
- **WS2812 타이밍 측정**: DMA 재기동 주기를 추적하여 LED 토글 시에도 프레임 드롭이 발생하지 않는지 검증합니다.
- **호스트 LED 동기성 테스트**: Windows/Linux 양쪽에서 Caps Lock 토글 후 LED 반영 지연을 1ms 이내로 유지하는지 로깅합니다.
- **회귀 테스트**: Suspend/Resume, NKRO 토글 등 다른 HID `SET_REPORT` 요청이 기존 동작을 유지하는지 점검합니다.

## 4. 산출물
- `src/hw/driver/usb/usb_hid/usbd_hid.c` 및 관련 HAL 래퍼 수정
- LED 서비스 플래그 및 후처리 함수 구현 파일 (예: `src/ap/modules/qmk/port/sys_port.c`)
- UART 로그 비동기화 또는 레벨 조정 패치
- 검증 결과 정리 문서 및 펌웨어 버전 업데이트 (`_DEF_FIRMWATRE_VERSION` → `V251010R3` 가정)

---

## 수정 내역
- USB HID 드라이버에 호스트 LED 동기화 버퍼와 `usbHidServiceStatusLed()`/`usbHidResetStatusLedState()`를 추가해 인터럽트 컨텍스트에서 LED 처리를 제거했습니다.
- `keyboard_task()`에 호스트 LED 서비스 진입점을 배치하고, 보드 포트의 `usbHidSetStatusLed()`가 메인 루프에서 직접 RGB 인디케이터를 갱신하도록 조정했습니다.
- USB 리셋/서스펜드 시 호스트 LED 대기 상태를 초기화하도록 `usbd_conf.c`를 갱신하고, 펌웨어 버전을 `V251010R3`으로 올렸습니다.
