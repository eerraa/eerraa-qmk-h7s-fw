# RGB 인디케이터 정지 현상 재정리 (TEST 브랜치, V251116R1 베이스)

## 전제
- 브랜치(RGB)가 V251118R7까지 다수 수정됐으나 근본 해결에 실패해 TEST 브랜치로 돌아온 상태이다.
- 증상: CAPS 인디케이터(전체 녹색 오버라이드)와 Snake 6 등 동적 이펙트를 동시에 사용할 때 CAPS ON/Off 전환 후 LED가 녹색으로 덮이지 않거나 Snake 6가 멈춰 보이는 문제가 반복된다.

## Codex 원래 제안(요약)
1) DMA 완료 대기·재시도: `ws2812_setleds()/ws2812Refresh()`에서 DMA 완료를 확인하고 HAL_BUSY면 `needs_render` 유지 후 재시도.  
2) DMA 전송 실패 감지 후 오버레이 재예약: `ws2812Refresh()` 실패 시 `rgblight_indicator_state.needs_render` 재설정 또는 `rgblight_request_render()` 재호출.  
3) 인디케이터 해제 즉시 프레임 재생성: CAPS OFF 시 `rgblight_render_frame()` 혹은 `rgblight_mode_noeeprom()`으로 Snake 버퍼 즉시 복구.  
4) 주기적 오버레이 반복(사용자 제안): 인디케이터 활성 중 동일 프레임을 주기적으로 덮어쓰기.

## 다른 브랜치(RGB)에서의 시행착오 및 관찰 요약
- V251116R1: CPU/DMA 더블 버퍼 도입으로 버퍼 경합은 제거됐지만 CAPS ON/OFF 정지 재현.  
- V251116R2~R4: DMA 큐·타임아웃·CLI 계측 추가, 이벤트 기반 파이프라인(Idle 이벤트→`rgblight_task`) 1단계 적용 후에도 정지 반복. DMA 카운터는 항상 정상(0/READY).  
- V251118R1~R4: DMA Idle 이벤트 브리지, 렌더 상태 머신 계측 추가 완료. 그럼에도 CAPS ON 반복 시 `refresh req/start`가 멈추고 LED가 동결. DMA Busy/Timeout은 관측되지 않음.  
- 공통 관찰: `rgblight log on`으로 루프가 느려지면 재현되지 않고, `log off`에서만 정지 재현 → 루프/스케줄링 결함을 시사.  
- `rgblight_timer_task()`가 인디케이터 전체 오버라이드 시 애니메이션을 중단(또는 중복 요청만 반복)하며, Snake 6 프레임이 큐에 오르지 않아 DMA가 쉴 때가 있음. CAPS OFF에서만 다시 렌더가 살아나는 패턴 다수 확인.

## 제외 또는 우선도 하향할 제안
- DMA 대기·재시도(옵션 1), DMA 실패 재예약(옵션 2): 여러 버전에서 구현·검증했으며 DMA 계층은 Busy/Timeout 없이 정상 수치만 기록됨. 현재 TEST 베이스에서는 근본 원인이 아니므로 재도입 우선도가 낮음.
- 주기적 오버레이 반복(옵션 4): V251118R5/6 등에서 시도 시 Snake 6 정지·중복 요청 폭증만 확인, 효과 없음. 재도입 불필요.

## 여전히 유효한/필요한 방향
- 인디케이터 활성 중에도 베이스 이펙트(Snake 6)가 최소 주기로 렌더를 큐잉하도록 스케줄링 재설계(인디케이터→베이스→오버레이 순서 보장).  
- CAPS OFF 시 기본 이펙트 프레임을 즉시 한 번 요청해 녹색 잔상이 남지 않도록 하는 보강(원래 제안 3은 스케줄링 개선과 결합해 적용).  
- 렌더 큐/이벤트 상태 머신을 단순화·우선순위화해 `render_pending`/`needs_render`가 과소 소거되거나 중복 폭증하지 않도록 정리.  
- DMA 계측은 유지하되, 문제의 초점은 “렌더 요청이 올라오지 않는 스케줄링 결함”에 맞춰야 함.

## 결론
- DMA 영역 개선만으로는 문제가 해결되지 않았음이 V251116R1~V251118R7 실험으로 확인되었다.  
- 현재 TEST 브랜치에서는 스케줄링/애니메이션 경로를 재설계해 인디케이터 오버레이 중에도 베이스 이펙트 렌더가 지속되고, CAPS OFF에서 즉시 복구되도록 하는 방향이 핵심이다.  
- 원래 제안 중 인디케이터 해제 시 즉시 재렌더(옵션 3)는 스케줄링 보강과 함께 적용 가치가 있으며, DMA 관련 옵션은 보조(감시) 수준으로 유지한다.  

## V251120R1 적용 현황 및 잔여 작업
- 적용: `INDICATOR_ENABLE` 매크로에 따라 인디케이터 상태 머신/호스트 LED 큐/렌더 경로가 완전히 가드돼 brick60 외 키보드는 공통 스케줄러만 타도록 분리.  
- 적용: `rgblight_timer_task()` 조기 종료를 제거해 인디케이터 오버레이 중에도 베이스 이펙트가 주기적으로 큐잉되며, CAPS OFF 전이 시 기본 프레임을 즉시 요청하도록 상태 전이를 보강.  
- 적용: 인디케이터 미지원 보드에서 HID 호스트 LED 큐가 잔류하지 않도록 즉시 폐기.  
- 차이: 렌더 큐/이벤트 상태 머신(`render_pending`/`needs_render`) 단순화와 HID CAPS 이벤트 동시 처리 시 충돌 검증은 아직 미착수.  
- TODO: HID 경로와 애니메이션 스케줄러가 동시에 렌더를 요청할 때 큐 폭증/스톨 여부를 로깅으로 재검증하고, 필요 시 상태 머신 우선순위·플래그 정리를 이어서 수행.
