# MONITOR Review 35 (V251008R7)

## 개선안 후보 및 검토
1. **안정 임계(`expected_us << 1`)를 속도 파라미터 적용 시 캐시**
   - 개요: `usbHidSofMonitorApplySpeedParams()`에서 안정 임계값을 미리 계산해 구조체에 저장하고, ISR에서는 캐시만 비교한다.
   - 1) 성능 영향: SOF ISR마다 수행하던 시프트 연산과 32비트 임시 변수 생성을 제거해, 정상 프레임에서도 분기 전 실행 시간을 줄인다.
   - 2) 복잡도: 구조체 필드가 하나 증가하지만 Prime 경로에서만 갱신하므로 흐름이 단순하며, 기존 파라미터 테이블 사용 방식도 유지된다.
   - 3) 비정상 가능성: 안정 임계는 속도 파라미터 테이블과 동일한 조건에서 산출되어 Prime과 동기화되므로 감지 로직과 워밍업 동작이 기존과 동일하다.
   - **결론: 채택**

2. **HS/FS 속도 판정을 `<= USBD_SPEED_FULL` 비교로 단일화**
   - 개요: HS(0)·FS(1) 두 값을 OR 연산으로 비교하던 로직을 범위 비교로 치환해 분기를 단순화한다.
   - 1) 성능 영향: OR 비교 두 번을 한 번의 범위 비교로 줄여 ISR 분기 준비 비용을 감소시킨다.
   - 2) 복잡도: 열거형 값이 연속이라는 라이브러리 정의를 활용하는 단일 비교로, 기존 캐시 흐름을 유지하면서 코드가 더 간결해진다.
   - 3) 비정상 가능성: HAL에서 정의한 `USBD_SPEED_HIGH=0`, `USBD_SPEED_FULL=1` 범위를 그대로 사용하므로, HS/FS 외의 속도에서는 `false`가 되어 기존과 동일하게 초기화 루틴으로 빠진다.
   - **결론: 채택**

3. **다운그레이드 트리거 시 직전 누락 프레임 재사용**
   - 개요: 이미 `score >= degrade_threshold`인 상태에서는 새 `usbCalcMissedFrames()` 호출 대신 이전 프레임의 결과를 유지한다.
   - 1) 성능 영향: 추가 캐시를 관리해야 해 ISR 저장/불러오기가 늘어나며, 누락 프레임 재계산 비용을 상쇄하지 못할 가능성이 높다.
   - 2) 복잡도: 누락 프레임 캐시의 수명 주기와 동기화 지점을 새로 정의해야 해 다운그레이드 큐와 ISR 모두 수정이 필요하다.
   - 3) 비정상 가능성: 오래된 누락 프레임을 보고하면 다운그레이드 로그 및 확인 단계가 실제 간격과 어긋나 USB 불안정성 판단이 왜곡될 위험이 있다.
   - **결론: 기각**

## 최종 적용 개선안
- 1번, 2번 개선안을 적용해 최종 코드를 작성하였다.
