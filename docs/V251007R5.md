# MONITOR Review 24 — 후보 개선안 검토 (V251007R5)

## 1. 후보 개선안 목록
1. **`usbRequestBootModeDowngrade()`가 타임스탬프를 필요 시에만 획득**
2. **다운그레이드 ARM 진입 시 확인 지연 값을 로컬로 캐시하여 타임아웃을 산출**
3. **ARM 단계에서 동일 측정치 재기록을 건너뛰는 비교 추가**

## 2. 후보별 검토
### 1) `usbRequestBootModeDowngrade()`가 타임스탬프를 필요 시에만 획득
- **성능 영향**: 현재는 SOF ISR에서 `millis()`를 호출해 `usbRequestBootModeDowngrade()`에 전달한다. 큐가 이미 COMMIT 단계여서 요청이 거부될 때도 `millis()` 호출이 발생해 불필요한 HAL tick 접근이 남는다. 함수 내부에서 Stage를 확인한 뒤 필요한 경우에만 `millis()`를 호출하도록 지연시키면, 거부 경로에서는 완전히 비용이 제거되고 ARM/CONFIRM 경로도 단 한 번만 호출된다.
- **복잡도 변화**: 함수 내부에 타임스탬프 캐시용 불리언과 지연 호출 분기를 추가하는 정도라 구조가 단순하다. 기존 파라미터 목록에서 `now_ms`를 제거해 호출부 역시 간결해진다.
- **USB 불안정성 탐지 리스크**: `millis()` 기준 시각을 그대로 사용하므로 ARM→COMMIT 확인 타이밍은 변하지 않는다. Stage 별 분기 순서도 동일해 비정상 작동 가능성이 없다.
- **결론**: 적용.

### 2) 다운그레이드 ARM 진입 시 확인 지연 값을 로컬로 캐시하여 타임아웃을 산출
- **성능 영향**: ARM 단계에 진입할 때 `ready_ms`를 먼저 기록한 뒤, 같은 구조체 필드를 다시 읽어 `timeout_ms`를 계산하고 있다. 로컬 변수에 확인 지연 값을 캐시해 `ready_ms`와 `timeout_ms`를 한 번의 로컬 값으로 계산하면 구조체 재로드가 제거되어 메모리 접근이 줄어든다.
- **복잡도 변화**: 로컬 변수 두 개를 도입해 덧셈 순서를 정리하는 수준으로, 오히려 코드 가독성이 좋아진다.
- **USB 불안정성 탐지 리스크**: 계산식은 기존과 동일한 상수(`USB_BOOT_MONITOR_CONFIRM_DELAY_MS`)를 사용하므로 ARM/타임아웃 시점에 변화가 없다.
- **결론**: 적용.

### 3) ARM 단계에서 동일 측정치 재기록을 건너뛰는 비교 추가
- **성능 영향**: 다운그레이드가 대기 중일 때 동일한 `missed_frames`와 `delta_us`가 반복 전달될 수 있다. 캐시된 값과 비교해 변동이 없으면 재기록을 생략하면 메모리 쓰기를 줄일 수 있으나, 이를 위해 매번 4개의 비교가 추가되어 분기 비용이 더 커질 수 있다.
- **복잡도 변화**: 비교와 분기가 늘어나며, ‘동일 값일 때는 갱신하지 않는다’는 규칙을 문서화해야 해 유지보수 부담이 증가한다.
- **USB 불안정성 탐지 리스크**: 측정치가 더 악화되었는데 이전 값과 동일하다고 잘못 판단할 경우(예: 다운샘플된 값), 로그에 가장 최근 데이터를 남기지 못한다. 탐지 로직은 그대로지만 분석용 정보 손실 위험이 있다.
- **결론**: 미적용.

## 3. 최종 적용 내역
- 후보 1, 2를 채택해 다운그레이드 큐가 Stage별로 필요한 시점에만 `millis()`를 호출하고, ARM 진입 시 확인 지연 값을 로컬에서 계산하도록 정리했다.
- 수정 후 `usbHidMonitorSof()` → `usbRequestBootModeDowngrade()` → `usbProcess()` 흐름을 따라가며, 타임스탬프 계산과 Stage 전환, 타임아웃 판정이 기존과 동일하게 작동함을 재확인했다.
