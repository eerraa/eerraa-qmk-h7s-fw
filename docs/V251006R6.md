# MONITOR Review 16 (V251006R6)

## 개선안 후보 목록

### 1. SOF ISR에서 `dev_speed` 지연 로드
- **아이디어**: `usbHidMonitorSof()` 초기에 항상 읽던 `pdev->dev_speed`를, 실제로 속도가 필요한 상태(구성 완료 또는 서스펜드)에서만 읽도록 조건부로 로드한다.
- **성능 영향**: 기본/주소 상태 등 구성 전 단계에서는 불필요한 MMIO 접근이 제거되어 ISR 진입 부담이 미세하게 감소한다.
- **복잡도 영향**: 조건 한 줄 추가 수준으로 구조는 그대로 유지되어 복잡도 증가는 없다.
- **USB 불안정성 영향**: 기존 분기 흐름이 그대로 유지되며, 구성/서스펜드 상태에서만 속도를 참조하므로 로직 오동작 가능성은 없다.
- **결론**: **채택**. 최종 코드에 반영한다.

### 2. 워밍업 완료 상태 로컬 캐시
- **아이디어**: `mon->warmup_complete`를 여러 번 읽는 대신 로컬 변수로 캐시하고, 상태 전환 시 로컬/구조체를 동기화한다.
- **성능 영향**: 구조체 반복 접근이 줄어들어 ISR 내 로드 수를 줄인다.
- **복잡도 영향**: 상태 전환 시 로컬 변수 업데이트 한 줄만 추가되어 기존보다 복잡도가 증가하지 않는다.
- **USB 불안정성 영향**: 워밍업 완료 플래그를 동일한 시점에 true로 전환하며 기존 분기와 동일하게 동작하므로 위험이 없다.
- **결론**: **채택**. 최종 코드에 반영한다.

### 3. 기대 간격 이하 간격에서 `usbCalcMissedFrames()` 호출 생략
- **아이디어**: `delta_us <= expected_us`일 때 누락 프레임 계산을 건너뛰어 산술을 줄인다.
- **성능 영향**: 표면적으로는 나눗셈 호출을 줄일 수 있지만, 현 구조에서는 해당 분기 전에 이미 `delta_us >= stable_threshold_us` 조건을 통과해야 하므로 실행되지 않는 코드가 된다.
- **복잡도 영향**: 의미 없는 분기가 추가되어 가독성이 나빠질 수 있다.
- **USB 불안정성 영향**: 조건이 잘못 배치될 경우 정상 프레임에서 조기 반환이 발생할 여지가 있다.
- **결론**: **보류**. 실제 성능 이점이 없어 적용하지 않는다.

### 4. 패널티 누적 로직을 포화 덧셈으로 전환
- **아이디어**: `score + penalty` 계산을 포화 덧셈 헬퍼로 감싸고 단일 비교로 다운그레이드를 판정한다.
- **성능 영향**: 별도 헬퍼 호출이 필요해 오히려 분기 수가 늘어날 수 있다.
- **복잡도 영향**: 포화 연산 보조 함수를 추가해야 하므로 코드가 복잡해진다.
- **USB 불안정성 영향**: 점수 누적 경계 조건이 바뀌어 다운그레이드 트리거 타이밍이 달라질 위험이 있다.
- **결론**: **보류**. 기존 로직을 유지한다.

## 채택안 요약
- SOF ISR에서 필요 시에만 `pdev->dev_speed`를 읽도록 변경한다.
- 워밍업 플래그를 로컬 변수로 캐시해 구조체 접근을 최소화한다.

## 후속 조치
- 위 채택안을 코드에 반영한 뒤 USB 불안정성 감지 흐름을 재검증한다.
- 레퍼런스 문서(`docs/dev_monitor_codex_reference.md`)를 최신 로직에 맞춰 갱신한다.
- 최종 빌드 테스트를 수행한다.
