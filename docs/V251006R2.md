# MONITOR Review 12 (V251006R2)

## 개선안 후보 목록
1. 비구성 상태 분기에서 `score`를 0으로 다시 쓰는 코드를 제거해 불필요한 구조체 쓰기를 없앤다.
2. SOF ISR에서 한 번 읽은 `pdev->dev_speed` 값을 서스펜드/복귀, 속도 확인 분기에서 재사용해 레지스터 접근을 줄인다.
3. 다운그레이드 경로에서만 `missed_frames`를 16비트로 포화 변환해, 임계 미충족 시 불필요한 산술을 줄인다.

---

### 후보 1. 비구성 상태 점수 재초기화 제거
- **성능 영향**: `USBD_STATE_CONFIGURED`가 아닌 동안 ISR이 매 프레임 호출되며, 현행 코드는 항상 `mon->score`를 검사 후 0을 다시 기록한다. Prime 시 이미 점수가 0으로 초기화되므로 이 쓰기는 완전히 중복이며 제거 시 비구성 구간 동안 구조체 쓰기가 사라진다.
- **복잡도 영향**: 조건문을 제거하는 수준으로 흐름 변경이 없고, 상태 초기화는 Prime이 단일 책임을 유지한다.
- **USB 불안정성 영향**: 상태 전환 시 항상 Prime이 호출되어 점수를 0으로 만들기 때문에, 추가로 0을 기록하지 않아도 재구성 이후의 감시 상태에는 변화가 없다. 점수 값이 남아 있을 수 있는 경우가 존재하지 않아 오동작 위험이 없다.
- **결론**: **채택**.

### 후보 2. `dev_speed` 단일 캐싱
- **성능 영향**: 기존에는 서스펜드 분기와 정상 감시 분기에서 각각 `pdev->dev_speed`를 읽는다. 동일한 프레임 내에서 속도가 변하지 않으므로 한 번만 읽어 재사용하면 AHB 로드 1회를 절감하고, 컴파일러가 레지스터를 재사용할 수 있다.
- **복잡도 영향**: 읽기 위치를 `USBD_STATE_CONFIGURED` 확인 직후로 이동시키는 것 외 제어 흐름이 동일하다. 가독성도 기존보다 단순해진다.
- **USB 불안정성 영향**: `USBD_is_suspended()` 호출이 속도 값을 변경하지 않으므로 미리 읽은 값을 서스펜드 분기와 복귀 분기 모두에서 안전하게 사용할 수 있다. 속도 변경 감지는 여전히 Prime 경로를 통해 수행되며, 잘못된 속도로 감시가 진행될 가능성은 없다.
- **결론**: **채택**.

### 후보 3. `missed_frames` 포화 변환 지연
- **성능 영향**: 현재는 다운그레이드가 발생하지 않는 정상 프레임에서도 `missed_frames`를 16비트 범위로 포화시킨다. 포화 변환을 다운그레이드가 실제로 실행될 때만 수행하면 산술과 분기를 줄여 ISR 실행 시간을 조금이나마 절감할 수 있다.
- **복잡도 영향**: 포화 변환 한 줄을 다운그레이드 분기 내부로 옮기는 정도로 로직이 단순화된다. `missed_frames` 원본 값은 이미 상위 스코프에 있으므로 추가 상태 관리가 필요 없다.
- **USB 불안정성 영향**: 다운그레이드 요청에 전달되는 값만 포화하면 되므로 정상 경로 계산 결과에는 영향이 없다. 포화 변환을 지연해도 요청에 사용되는 값이 바뀌지 않아 탐지 민감도나 큐 처리 순서가 변하지 않는다.
- **결론**: **채택**.

---

## 최종 채택 개선안
- 비구성 상태에서는 Prime이 점수를 초기화하므로, 중복 쓰기를 제거해 비구성 구간의 구조체 접근을 줄였다.
- `pdev->dev_speed`를 한 번만 읽고 서스펜드/복귀 및 속도 확인 분기에서 재사용해 레지스터 접근을 최소화했다.
- 다운그레이드가 실제로 일어날 때만 `missed_frames`를 16비트로 포화해 불필요한 산술을 제거했다.

## USB 불안정성 탐지 흐름 재검증 메모
1. **상태 전환/Prime**: `dev_state` 변화 시 Prime이 호출되어 점수, 타임스탬프, 홀드오프가 재설정된다. 비구성 상태에서는 추가로 점수를 0으로 쓸 필요가 없으며, Prime 이후 즉시 `usbHidSofMonitorSyncTick()`이 prev_tick을 최신화한다.
2. **서스펜드 처리**: `dev_state == CONFIGURED` 이후 한 번 읽은 `dev_speed`를 이용해 서스펜드 진입 시 Prime을 호출하고, 복귀 시 동일 값을 사용해 홀드오프를 재적용한다. 속도 변경은 이후 분기에서 동일 변수로 감지된다.
3. **워밍업**: 워밍업 로직과 타임아웃 비교는 그대로 유지되어 안정 구간 진입 조건이 변하지 않는다.
4. **정상 감시/다운그레이드**: `missed_frames` 포화 변환을 다운그레이드 분기 안으로 옮겼지만, 요청에 전달되는 값과 판정 순서는 동일하다. 포화가 실행될 때는 반드시 다운그레이드가 발생하므로 큐에 전달되는 데이터 형식이 변하지 않는다.

