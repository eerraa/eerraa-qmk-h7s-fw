# FS SOF 기반 백업 전송 타이머 검토 (V251012R1)

## 1. 검토 배경
- HS 모드에서는 uSOF(125µs) 타이머가 약 120µs 지점에서 백업 전송 루트를 기동하도록 구성되어 있습니다.
- FS 모드에서도 동일한 120µs 지연이 적용되어 1ms 프레임 초반에 백업 경로가 실행되며, 이는 호스트 IN 토큰과 경합할 여지가 있습니다.
- 사용자 요청(V251012R1)에 따라 FS 환경에서 백업 전송 실행 시점을 프레임 후반(약 975µs)으로 이동하는 방안을 검토했습니다.

## 2. 계측 및 조건 분석
- `TIM2`는 `TIM_SLAVEMODE_COMBINED_RESETTRIGGER` 모드로 SOF 펄스에 동기화되며, `Prescaler=299` 구성으로 1µs 단위 카운트를 제공합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1432-L1456】
- HS 모드에서는 주 전송이 마이크로프레임 초반(0~80µs) 안에 완료되며, 120µs 지연이 백업 경로 실행에 충분한 여유를 제공합니다.
- FS 모드에서는 호스트가 1ms 주기 중 800µs 이상을 키보드 IN 토큰으로 활용하며, 120µs 시점에 백업 전송을 시작하면 아직 진행 중인 주 전송과 겹칠 가능성이 있습니다.
- FS 프레임 말단에는 25µs 정도의 여유를 확보할 수 있으므로, 975µs 지점에 백업 루트를 배치하면 충돌을 피하면서 차기 프레임 시작 전 완료할 수 있습니다.

## 3. 대안 비교
| 후보 지연 | 장점 | 단점 |
| --- | --- | --- |
| 120µs 유지 | 코드 변경 불필요, HS와 동일한 구성 | FS에서 주 전송과 경합 가능, 비상 경로가 지나치게 이른 시점에 실행 |
| 600µs 중간 지점 | 일부 경합 완화 | 여전히 호스트 IN 토큰과 충돌 가능, 프레임 후반 버스 상태를 확인하지 못함 |
| **975µs (선택)** | 프레임 종료 직전 실행으로 경합 최소화, 차기 프레임까지 25µs 안전 여유 확보 | 타이머 지연이 길어짐에 따라 인터럽트 응답이 프레임 마감 시간에 가까워짐 |

## 4. 결정 및 구현
- FS 모드일 때만 타이머 비교값을 975로 조정하고, HS/uSOF 환경은 기존 120을 유지하도록 분기 함수를 추가했습니다.【F:src/hw/driver/usb/usb_hid/usbd_hid.c†L1415-L1461】
- 변경으로 인해 `_DEF_FIRMWATRE_VERSION`을 `V251012R1`로 갱신했습니다.【F:src/hw/hw_def.h†L5-L13】

## 5. 기대 효과와 주의 사항
- **이득**: FS 프레임 중 핵심 전송 구간과 백업 루트 실행이 분리되어 USB 버스 충돌 가능성이 줄어듭니다.
- **손실/부작용**: 타이머 인터럽트가 프레임 끝부분(975µs)에서 발생하므로, 호스트의 SOF 지터가 ±20µs를 초과할 경우 다음 프레임에 영향을 줄 수 있습니다. 현행 모니터는 SOF 지터를 감시하므로 필요시 추가 보정이 가능합니다.
- **적용 여부**: FS 모드 한정으로 975µs 지연을 적용하며, 향후 버스 점유율 이상이 감지되면 계측 로그(`usbhid rate`)를 통해 조정 여부를 재검토합니다.

## 6. 추후 관찰 항목
- 다운그레이드 큐가 FS 모드에서 반복 트리거되는지 모니터링하여, 백업 루트 지연 증가로 인한 응답성 저하가 없는지 확인합니다.
- 타이머 오프셋 계측(`timer_sof_offset_us`)을 CLI에서 주기적으로 확인하여 SOF 지터 허용 범위 내인지 검증합니다.【F:src/hw/driver/usb/usb_hid/usbd_hid_instrumentation.c†L48-L120】
