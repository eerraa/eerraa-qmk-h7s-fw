# MONITOR Review 4

## 개선안 후보 및 검토 결과
1. **SOF 타임스탬프 비교 보조 함수 인라인화**
   - 내용: `usbHidTimeIsBefore()`와 `usbHidTimeIsAfterOrEqual()`을 `static inline`으로 선언해 SOF ISR에서의 함수 호출 오버헤드를 제거한다.
   - (1) 성능 영향: 두 함수는 SOF마다 여러 번 호출되므로 인라인화 시 분기 예측 및 레지스터 재사용이 좋아져 수 µs 수준의 이득이 기대된다.
   - (2) 복잡도: 선언 한 줄만 수정하면 되며, 호출부 로직은 그대로 유지된다.
   - (3) 비정상 작동 가능성: 함수 본문이 동일하게 유지되므로 동작 변화가 없다.
   → **채택**

2. **워밍업 분기에서 구조체 쓰기 최소화 및 타임아웃 접근 지연**
   - 내용: 워밍업 카운터(`warmup_good_frames`)의 변경 여부를 확인한 뒤 값이 바뀔 때만 구조체를 갱신하고, 워밍업 타임아웃(`warmup_deadline_us`)은 필요 시점에만 읽는다.
   - (1) 성능 영향: 평시 안정 구간에서는 동일 값 쓰기를 피하고, 워밍업 완료 시에는 타임아웃 필드 접근도 건너뛰어 메모리 버스를 절약한다.
   - (2) 복잡도: 원본 값을 로컬에 보관하고 조건 분기를 추가하는 수준으로 가독성이 유지된다.
   - (3) 비정상 작동 가능성: 값 비교 후 동일하게 갱신하거나 지연 읽기하는 구조는 로직과 일치하며, 경계 조건(0→0 유지)도 명시적으로 다룬다.
   → **채택**

3. **다운그레이드 요청 거절 시 점수 유지**
   - 내용: `usbRequestBootModeDowngrade()`가 `REJECTED`를 반환하면 SOF 점수를 보존해 다음 프레임에서 즉시 재시도한다.
   - (1) 성능 영향: 점수가 유지되면 곧바로 임계에 도달해 큐가 반복 호출되므로 오히려 루프 부하가 늘 수 있다.
   - (2) 복잡도: 요청 결과에 따라 점수를 보존/초기화하는 분기 관리가 추가되어 ISR이 복잡해진다.
   - (3) 비정상 작동 가능성: 큐가 `ARMED` 상태일 때 점수가 계속 남아 있으면 재시도 로그가 폭주하거나 다운그레이드가 과도하게 이루어질 위험이 있다.
   → **기각**

## 최종 반영 요약
- 개선안 1, 2를 적용해 SOF ISR의 타임스탬프 비교 호출을 인라인화하고, 워밍업 카운터·타임아웃 접근을 필요한 경우에만 수행하도록 최적화했다.
- 변경 후 `usbHidMonitorSof()`의 상태 전환(서스펜드/홀드오프 → 워밍업 → 감시)과 `usbRequestBootModeDowngrade()` 큐 연동을 따라가며 정상 동작을 재확인했다.
