# MONITOR Review 17 (V251006R7)

## 개선안 후보 목록

### 1. 서스펜드 분기 선행 및 동기화 생략
- **아이디어**: `usbHidMonitorSof()`에서 `USBD_STATE_SUSPENDED`를 일반 `CONFIGURED` 판정보다 먼저 처리해, 서스펜드 구간에서는 `usbHidSofMonitorSyncTick()` 호출을 건너뛴다.
- **성능 영향**: 서스펜드 상태에서는 매 프레임마다 구조체 타임스탬프를 갱신하지 않아 불필요한 메모리 쓰기를 제거한다. 또한 이후 분기 검사에 도달하지 않아 분기 예측 부담도 줄어든다.
- **복잡도 영향**: 상태 비교 순서를 조정하는 수준이며, 조건문이 명확해져 오히려 흐름이 간결해진다.
- **USB 불안정성 영향**: 서스펜드 전환 시점에는 이미 Prime으로 타임스탬프가 초기화되어 있어 추가 동기화가 필요 없다. 조기 반환이 기존보다 빠르지만, 워밍업·점수 로직은 서스펜드 상태에서 실행되지 않아 의도와 동일하다.
- **결론**: **채택**. 최종 코드에 반영한다.

### 2. 서스펜드 최초 진입 시 속도 파라미터 재적용 경량화
- **아이디어**: 서스펜드 첫 SOF에서 전체 Prime을 다시 호출하는 대신, 필요할 때만 `usbHidSofMonitorApplySpeedParams()`로 속도 파라미터를 맞춰두고 `suspended_active` 플래그만 세트한다.
- **성능 영향**: Prime이 수행하던 다수의 구조체 초기화가 제거되어 첫 서스펜드 SOF 처리 비용이 줄어든다. 재개 시에는 기존과 동일하게 속도 캐시를 재사용해 재적용 연산을 최소화한다.
- **복잡도 영향**: 조건 한 블록이 간결해지며, Prime 호출이 제거되어 흐름이 단순화된다.
- **USB 불안정성 영향**: 서스펜드 진입 시점에 이미 Prime이 실행되어 핵심 필드는 초기화되어 있다. 파라미터만 재적용하므로 점수/워밍업 상태는 유지되며, 다운그레이드 큐나 타임아웃 동작에는 영향이 없다.
- **결론**: **채택**. 최종 코드에 반영한다.

### 3. 다운그레이드 시 `holdoff_end_us` 갱신 조건 축소
- **아이디어**: 다운그레이드 요청이 거절된 경우에는 `mon->holdoff_end_us`를 다시 쓰지 않고 기존 값을 유지한다.
- **성능 영향**: 거절 케이스는 드물고, 조건 분기 추가로 오히려 실행 경로가 복잡해져 이득이 없다.
- **복잡도 영향**: 다운그레이드 분기 내부에 추가 조건이 생겨 가독성이 떨어진다.
- **USB 불안정성 영향**: 거절 경로에서 홀드오프를 갱신하지 않으면, 이후 프레임에서 즉시 다시 다운그레이드를 시도해 과도한 요청이 발생할 수 있다.
- **결론**: **보류**. 기존 갱신 로직을 유지한다.

## 채택안 요약
- 서스펜드 상태를 일반 비구성 분기보다 먼저 처리하고, 동기화 호출을 생략한다.
- 서스펜드 첫 SOF에서는 필요 시 속도 파라미터만 재적용하고 Prime 재호출을 제거한다.

## 후속 조치
- 채택안을 코드에 반영하고 USB 불안정성 감지 흐름을 재검증한다.
- 레퍼런스 문서(`docs/dev_monitor_codex_reference.md`)를 최신 로직에 맞게 갱신한다.
- 최종 빌드 테스트를 수행한다.
