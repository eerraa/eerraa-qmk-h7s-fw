# USB 불안정성 탐지 로직 최적화 검토

## 개선안 1: SOF 속도 파라미터 조회 루프 제거
- **개요**: `usbHidSofMonitorApplySpeedParams()` 내부에서 속도별 파라미터를 찾기 위해 반복문을 사용하던 부분을 상수 테이블 인덱스를 이용한 분기로 대체해, 8kHz ISR 경로에서의 불필요한 반복 비교를 제거한다.
- **1. 성능 영향 검토**: 속도 전환 시 최대 두 번 반복하던 비교가 단일 분기로 축소되어, 워밍업/재개 시점의 파라미터 적용이 더 짧은 경로로 끝난다. 빈도는 낮지만 ISR에서 실행되므로 미미하더라도 긍정적 효과이다.
- **2. 복잡도 검토**: 속도별 분기가 명시적으로 표현되어 가독성이 향상되며, 향후 속도 추가 시 상수 테이블 순서를 유지하면 된다. 복잡도 증가 없음.
- **3. 비정상 작동 가능성**: 기존과 동일한 파라미터 테이블을 참조하므로 기능 변경이 없고, 미지정 속도에 대해 0 초기화 경로도 유지된다. 비정상 작동 우려 없음.
- **4. 조치**: 모든 검토 결과가 긍정적이므로 `usbd_hid.c`에 V251004R1 변경을 반영했다.

## 개선안 2: 서스펜드 분기 후 속도 레지스터 접근 지연
- **개요**: `usbHidMonitorSof()`에서 SOF마다 `pdev->dev_speed`를 읽어두었으나, 서스펜드 감지로 즉시 반환하는 경로에서도 같은 접근이 반복되었다. 서스펜드/복귀 여부 판정 후에만 속도를 읽도록 순서를 조정해 메모리 접근을 줄인다.
- **1. 성능 영향 검토**: 서스펜드 구간(또는 워밍업 초기)에서 불필요한 레지스터 읽기가 사라져, ISR 진입 시 대기 없이 조기 반환한다. 빈도는 제한적이나 오버헤드 감소 측면에서 긍정적이다.
- **2. 복잡도 검토**: 분기 구조는 기존과 동일하며, 속도 값을 사용하는 지점에 지역 변수를 도입했을 뿐이다. 복잡도 증가 없음.
- **3. 비정상 작동 가능성**: 서스펜드 진입 시에는 기존과 동일하게 즉시 초기화가 이루어지고, 복귀 시점에는 속도를 다시 읽어 전달하므로 동작 변화가 없다. 비정상 작동 우려 없음.
- **4. 조치**: 모든 검토 결과가 긍정적이므로 `usbd_hid.c`에 V251004R1 변경을 반영했다.

## 최종 수정코드(V251004R1) 요약
- `usbHidSofMonitorApplySpeedParams()`가 속도별 파라미터를 직접 분기해 캐시하며, `_DEF_FIRMWATRE_VERSION`과 버전 주석을 `V251004R1`로 동기화했다.
- `usbHidMonitorSof()`는 서스펜드 감지 후에만 속도 레지스터를 읽어 ISR 경로의 불필요한 메모리 접근을 줄였다.

## USB 불안정성 감지 흐름 재검증
1. **상태 전이 감지**: USB 상태 변화 시 `usbHidSofMonitorPrime()`이 호출되어 타임스탬프, 홀드오프, 워밍업 파라미터가 초기화되고, 속도 파라미터가 즉시 복사된다.
2. **구성 전 상태**: 비구성/서스펜드 구간에서는 타임스탬프만 갱신하고 점수를 0으로 유지해 모니터링 부하가 발생하지 않는다.
3. **워밍업**: 홀드오프 종료 후 기대 간격 내 프레임이 누적되면 워밍업이 완료되고 감쇠 타이머가 동기화된다.
4. **안정 구간**: 안정 프레임에서는 점수가 감쇠되며, 누락 프레임이 발생한 경우에만 패널티를 가산한다.
5. **임계 초과 시 다운그레이드**: 누적 점수가 임계값에 도달하면 다운그레이드 요청이 ARM/COMMIT 순서로 진행되고, 홀드오프가 재설정되어 재측정을 준비한다.

상기 흐름을 따라가며 수정된 코드가 의도된 상태 머신을 유지함을 확인했다.
