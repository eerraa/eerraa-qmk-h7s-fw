# MONITOR Review 20 — 후보 개선안 검토 (V251007R1)

## 1. 후보 개선안 목록
1. **다운그레이드 요청 시 누락 프레임 최소값 보장**
2. **다운그레이드 큐 구조체 로컬 캐시 활용**
3. **요청 구조체 Stage/Mode 폭 축소(8비트화)**

## 2. 후보별 검토
### 1) 다운그레이드 요청 시 누락 프레임 최소값 보장
- **성능 영향**: ISR에서 전달한 `missed_frames`가 0일 때 재계산 루틴이 다시 실행되면서 `usbCalcMissedFrames()`가 불필요하게 호출된다. 요청 시점에 최소 1프레임으로 정규화하면 메인 루프 로그 경로가 캐시된 값을 그대로 사용하게 되어, 희귀 이벤트라도 CPU 사이클을 줄일 수 있다.
- **복잡도 변화**: 요청 함수에서 16비트 값을 한 번 더 검사하는 단순 분기만 추가된다. 기존 흐름을 변경하지 않아 복잡도 증가는 없다.
- **USB 불안정성 탐지 리스크**: 다운그레이드는 실제로 간격 초과가 발생했을 때만 호출되므로 최소 1프레임으로 정규화해도 오탐·미탐 조건을 바꾸지 않는다. 로그 표현만 일관되게 만들어 비정상 동작 우려가 없다.
- **결론**: 적용.

### 2) 다운그레이드 큐 구조체 로컬 캐시 활용
- **성능 영향**: `usbProcess()`는 메인 루프에서 자주 호출되는데, 전역 구조체 필드를 매번 직접 참조하면 불필요한 메모리 접근이 발생한다. 로컬 포인터와 캐시된 값을 활용하면 분기 내 반복 접근을 줄여 미세하게나마 메인 루프 비용을 줄일 수 있다.
- **복잡도 변화**: 로컬 변수 추가와 반복 사용으로 코드 흐름이 오히려 명확해진다. 로직 변화가 없으므로 복잡도는 상승하지 않는다.
- **USB 불안정성 탐지 리스크**: Stage 판정과 로그/타임아웃 처리는 기존과 동일한 조건을 사용하므로 동작 흐름이 변하지 않는다. 잘못된 Stage 전환이나 누락 프레임 계산 누락 위험도 없다.
- **결론**: 적용.

### 3) 요청 구조체 Stage/Mode 폭 축소(8비트화)
- **성능 영향**: 구조체 크기를 줄일 수 있으나, 큐는 매우 작은 빈도로만 업데이트되어 캐시 이득이 체감되기 어렵다.
- **복잡도 변화**: 8비트 저장 시 열거형과의 캐스팅이 곳곳에 필요해져 가독성이 떨어진다. 또한 추후 Stage/Mode가 늘어날 때 추가 검증 코드가 필요해진다.
- **USB 불안정성 탐지 리스크**: 캐스팅 실수나 새로운 Stage 추가 시 범위를 초과하면 Stage 판정이 잘못되어 큐가 비정상 동작할 수 있다.
- **결론**: 미적용.

## 3. 최종 적용 내역
- 후보 1, 2를 적용하여 누락 프레임 캐시를 정규화하고, 메인 루프 큐 처리에서 구조체 접근을 로컬 변수로 경량화한다.
