# MONITOR Review 18 (V251006R8)

## 개선안 후보 목록

### 1. 상태 전환 Prime 후 즉시 반환
- **아이디어**: `usbHidMonitorSof()`에서 USB 장치 상태가 바뀌어 Prime을 실행한 프레임은, 이후 분기들을 더 검사하지 않고 즉시 반환한다.
- **성능 영향**: Prime 직후에도 홀드오프/워밍업 계산을 위해 구조체 필드를 다시 읽고 비교하던 비용을 제거해 ISR 경로를 단축한다.
- **복잡도 영향**: Prime 수행 여부에 따라 조기 반환만 추가되므로 흐름이 오히려 명확해진다.
- **USB 불안정성 영향**: Prime이 이미 모든 상태 값을 초기화하므로 같은 프레임에서 추가 계산을 건너뛰어도 다음 SOF에서 정상적으로 홀드오프와 워밍업이 진행된다.
- **결론**: **채택**. 최종 코드에 반영한다.

### 2. SOF 임계 비교 결과 캐시화
- **아이디어**: `delta_us < stable_threshold` 비교 결과를 불리언으로 저장해 워밍업/감쇠 경로에서 재사용한다.
- **성능 영향**: 동일한 비교를 두 번 수행하던 연산을 한 번으로 줄여 분기 예측 부담과 산술을 절약한다.
- **복잡도 영향**: 불리언 캐시만 추가되므로 가독성이 유지된다.
- **USB 불안정성 영향**: 비교 결과를 재사용할 뿐 판단 기준은 동일하여 워밍업/감쇠/다운그레이드 흐름이 유지된다.
- **결론**: **채택**. 최종 코드에 반영한다.

### 3. 홀드오프 구간에서 `usbHidSofMonitorSyncTick()` 호출 제거
- **아이디어**: 홀드오프 중에는 타임스탬프를 갱신하지 않고, 홀드오프 종료 후 첫 SOF에서만 `prev_tick_us`를 갱신한다.
- **성능 영향**: 구조체 쓰기 한 번을 줄일 수 있다.
- **복잡도 영향**: 홀드오프 상태 추적 변수가 추가로 필요해 코드가 복잡해진다.
- **USB 불안정성 영향**: 홀드오프 동안 타임스탬프가 업데이트되지 않으면, 종료 시점의 첫 SOF에서 `delta_us`가 홀드오프 전 시각과의 차이를 계산해 잘못된 다운그레이드가 발생할 수 있다.
- **결론**: **기각**. 기존 동작을 유지한다.

## 채택안 요약
- 상태 전환이 발생한 프레임에서는 Prime 이후 즉시 반환해 불필요한 후속 분기 실행을 제거했다.
- SOF 간격 임계 비교 결과를 캐시하여 워밍업 및 감쇠 경로가 동일한 비교를 반복하지 않도록 했다.

## 후속 조치
- 채택안을 코드에 반영하고 USB 불안정성 감지 흐름을 재검증한다.
- 레퍼런스 문서(`docs/dev_monitor_codex_reference.md`)를 최신 로직에 맞게 갱신한다.
- 최종 빌드 테스트를 수행한다.
