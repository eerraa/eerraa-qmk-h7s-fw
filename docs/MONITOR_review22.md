# MONITOR Review 22 — 후보 개선안 검토 (V251007R3)

## 1. 후보 개선안 목록
1. **다운그레이드 보고 시 누락 프레임 최소값을 ISR에서 보장**
2. **`usbRequestBootModeDowngrade()`의 최소 프레임 재보정 분기 제거**
3. **`usbProcess()`의 Stage 분기를 `switch`로 재구성**

## 2. 후보별 검토
### 1) 다운그레이드 보고 시 누락 프레임 최소값을 ISR에서 보장
- **성능 영향**: 다운그레이드가 발생하는 희귀 경로에서만 실행되며, 기존에는 큐에 값을 전달한 뒤 `usbRequestBootModeDowngrade()`에서 최소 1프레임으로 재보정하고 있었다. 호출부에서 즉시 보정하면 큐 측 분기 실행이 사라져 총 분기 수가 줄고, ARM/COMMIT 단계 로그 출력 시 반복 검사를 하지 않아도 된다.
- **복잡도 변화**: 다운그레이드 경로 내부에 `if (missed_frames_report == 0)` 조건을 추가하는 단순 변경이며, 기존에 분리되어 있던 보정 책임을 호출부로 옮겨 흐름이 더 명확해진다.
- **USB 불안정성 탐지 리스크**: 보정 시점을 앞당길 뿐, 실제로 저장되는 값은 이전과 동일하게 최소 1프레임 이상으로 유지된다. 다운그레이드 판정이나 로그 수치에는 변화가 없어 비정상 동작 위험이 없다.
- **결론**: 적용.

### 2) `usbRequestBootModeDowngrade()`의 최소 프레임 재보정 분기 제거
- **성능 영향**: 후보 1이 선행되면 큐에 저장되는 `missed_frames`가 이미 1 이상으로 보장되어 중복 분기를 제거할 수 있다. ARM/COMMIT 단계에서도 동일 분기가 사라져 `usbProcess()` 루프의 조건 평가가 감소한다.
- **복잡도 변화**: 재보정 분기 삭제와 주석 업데이트만 필요하므로 코드가 더 간결해진다. Stage 상태 전이는 기존과 동일하게 유지된다.
- **USB 불안정성 탐지 리스크**: ISR에서 최소값을 확정하고 나면 큐 내부에서 다시 검사할 필요가 없다. 다운그레이드 요청이 존재할 때만 Stage가 `ARMED/COMMIT`이 되므로, 0이 저장될 경로는 남지 않는다.
- **결론**: 적용.

### 3) `usbProcess()`의 Stage 분기를 `switch`로 재구성
- **성능 영향**: 현재는 `if-else` 체인이며, Stage 값은 0~2 범위라 분기 예측이 안정적이다. `switch`로 바꾸면 동일한 비교가 생성될 가능성이 높아 실익이 없고, GCC/Clang이 자동으로 jump table을 만들지도 않는다.
- **복잡도 변화**: `switch`로 변환하면 각 case 내부에서 `return` 처리와 로그 분기 재구성이 필요해 가독성이 떨어질 수 있다.
- **USB 불안정성 탐지 리스크**: 분기 구조를 바꾸는 동안 `return` 누락이나 Stage 값 업데이트 시점이 틀어질 위험이 존재한다. 실익 대비 리스크가 크다.
- **결론**: 미적용.

## 3. 최종 적용 내역
- 후보 1, 2를 채택해 다운그레이드 큐에 전달되는 누락 프레임 값을 ISR에서 정규화하고, 큐 처리 경로의 중복 분기를 제거한다.
