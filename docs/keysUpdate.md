# `keysUpdate()` 제거 검토 보고서

## 1. 배경 및 목적
- DMA 순환 버퍼 기반 매트릭스 스캔이 도입된 이후 `keysUpdate()` 더미 함수가 헤더와 구현 파일에 남아 있었으며, V251009R1에서 API가 제거되었습니다.【F:src/common/hw/include/keys.h†L13-L19】【F:src/hw/driver/keys.c†L32-L304】
- QMK 브리지는 DMA 버퍼 포인터를 직접 참조하며, 레거시 CLI 경로는 DMA 자동 갱신과 중복되어 V251009R2에서 정리되었습니다.【F:src/ap/modules/qmk/port/matrix.c†L55-L144】【F:src/hw/driver/keys.c†L32-L330】
- 본 문서는 제안 A(`keysUpdate()` 제거)의 영향 범위와 부작용 가능성을 검토하고, 안전한 제거 계획을 수립하기 위해 작성되었습니다.【F:docs/features_keyinput_review.md†L11-L34】

## 2. 영향 범위 식별
| 구분 | 세부 내용 | 영향 분석 |
| --- | --- | --- |
| API 선언부 | `keys.h`에 `keysUpdate()` 프로토타입이 노출되었으나 V251009R1에서 삭제 | DMA 기반 스캔 전용화를 명시하는 주석으로 대체되어 공개 API가 정리되었습니다.【F:src/common/hw/include/keys.h†L13-L19】 |
| 구현부 | `keys.c`에는 DMA 버퍼 접근 함수만 유지되며 더미 구현이 제거됨 | 런타임 동작은 기존과 동일하고, CLI 진입점도 삭제되어 DMA 스냅샷만 노출합니다.【F:src/hw/driver/keys.c†L32-L330】 |
| QMK 매트릭스 폴백 | DMA 스냅샷 복사 실패 시 조기 탈출하도록 보강된 `#else` 블록을 V251009R3에서 제거 | 단일 DMA 경로만 유지되며, 레거시 스캔이 필요하면 별도 모듈화가 필요합니다.【F:src/ap/modules/qmk/port/matrix.c†L55-L99】 |
| CLI 키 매트릭스 뷰어 | DMA 자동 갱신 환경에서 실효성이 낮아 V251009R2에서 명령어를 삭제 | CLI 유지 보수 부담이 사라졌으나, 매트릭스 진단은 다른 계측 수단이 필요합니다.【F:src/hw/driver/keys.c†L36-L330】 |

## 3. 잠재 부작용 및 리스크 평가
1. **폴백 스캔 재사용성 감소**: DMA 경로 장애 시 즉시 대응할 대안이 사라졌으므로, 레거시 스캔을 유지하려면 독립 모듈로 보관하거나 별도 브랜치에서 관리해야 함.
2. **CLI 유지 보수성**: DMA 상시 갱신 구조에서는 CLI 반복 출력이 실질 이점이 없어 V251009R2에서 명령어를 제거했습니다. 향후 실장 디버그는 QMK `matrix info` 등 다른 진단 도구로 대체해야 합니다.【F:src/ap/modules/qmk/port/matrix.c†L101-L144】
3. **API 변경 공지 필요**: 외부에서 `keysUpdate()` 호출을 기대하던 코드가 있다면 컴파일 오류가 발생. 현재 저장소에서는 사용 사례가 없으나, 포팅 코드 병합 시 주의를 요함.

## 4. 제거 절차 제안
1. **API 정리**
   - `keys.h`에서 `keysUpdate()` 선언을 삭제하고, 필요 시 대체할 레거시 스캔 API 명세를 문서화.
2. **구현 제거**
   - `keys.c`의 더미 함수를 제거하고, DMA 자동 갱신 주기만 유지한다는 주석을 추가.
3. **호출부 정리**
   - `matrix.c` 폴백 블록에서 `keysUpdate()` 호출을 삭제하고, DMA 스냅샷 복사 실패 시 조기 탈출하도록 보완.
   - CLI 키 매트릭스 뷰어는 DMA 자동 갱신과 중복되어 삭제하고, 필요 시 QMK 계측 CLI(`matrix info`) 사용을 안내.
4. **관련 문서 갱신**
   - `features_keyinput.md` 및 CLI 사용 설명서에서 레거시 폴링 함수 호출 안내를 제거하고, DMA 기반 모니터링 흐름을 반영.
5. **검증**
   - 기본 빌드(`cmake --build`)가 통과하는지 확인.
   - CLI `keys info` 명령 실행 시 행/열 출력이 정상적으로 갱신되는지 실장 보드에서 확인.

## 5. 권장 타임라인 및 후속 조치
- **1단계 (V251009R1)**: API/구현 제거 및 호출부 정리, 문서 업데이트 — **완료**.
- **2단계 (V251009R2)**: CLI 명령 유지 필요성을 검토해 `keys`/`keys info`를 제거하고 대체 진단 경로를 명시 — **완료**.
- **3단계 (V251009R3)**: `matrix.c`의 폴백 블록을 제거하고, 독립 모듈 분리 방안과의 비교 결과를 문서화 — **완료(선택지 1 채택)**.

## 5.1 3단계 선택지 비교 (V251009R3)
- **선택지 1 — 폴백 블록 제거**
  - *장점*: dead code가 사라져 DMA 경로만 검증하면 되며, QMK 쪽 유지보수 부담이 줄어듭니다.【F:src/ap/modules/qmk/port/matrix.c†L55-L99】
  - *단점*: DMA 외 대안 스캔이 즉시 제공되지 않아, 드라이버 불안정 시 임시 대응이 어렵습니다.
- **선택지 2 — 독립 모듈로 분리**
  - *장점*: 레거시 스캔 코드를 아카이브 형태로 남겨 필요 시 링크만으로 활성화할 수 있습니다.
  - *단점*: 별도 모듈을 동기화해야 하고, 테스트 범위가 다시 넓어져 코드 베이스가 복잡해집니다.

**결론**: DMA 전용 운영 정책에 맞춰 선택지 1을 채택했습니다. 레거시 경로가 필요할 경우, `keysReadColsBuf()` 기반 스냅샷 복사를 별도 드라이버 파일로 구성해 선택적으로 빌드하는 방안을 후속 연구 과제로 남깁니다.【F:src/hw/driver/keys.c†L295-L304】

## 6. 결론
- `keysUpdate()`는 현재 펌웨어의 DMA 기반 스캔 경로에서 기능적 역할이 없으며, 제거 시 런타임 부작용 가능성이 낮습니다.
- 제거 작업은 API 정리와 문서 갱신이 동반되어야 하며, CLI/폴백 경로에 대한 운영 팀 공지가 필요합니다.
- 상기 계획에 따라 순차적으로 제거를 진행하면 코드 간결화와 유지보수 비용 절감 효과를 기대할 수 있습니다.

## 7. 실행 결과 요약
- (V251009R1) 공개 API에서 `keysUpdate()` 프로토타입을 제거하고, DMA 전용 주석을 추가했습니다.【F:src/common/hw/include/keys.h†L13-L19】
- (V251009R2) CLI `keys`/`keys info` 명령은 DMA 상시 갱신 환경에서 실효성이 낮아 삭제하고, 디버그 안내를 QMK 계층으로 일원화했습니다.【F:src/hw/driver/keys.c†L32-L330】
- (V251009R3) QMK 폴백 블록을 제거해 DMA 전용 경로만 유지하고, 레거시 복사 스캔은 별도 모듈로 보관하도록 방향을 확정했습니다.【F:src/ap/modules/qmk/port/matrix.c†L55-L84】

## 8. CLI 명령 유지 필요성 분석 (V251009R2)
- **원래 역할**: DMA 도입 전 CLI `keys info`는 `keysUpdate()`를 호출해 소프트웨어 스캔 결과를 행/열 매트릭스로 표시했습니다. 하드웨어 타이밍 확인과 키 불량 진단이 목적이었습니다.
- **DMA 이후 변화**: 현재는 DMA 버퍼가 상시 갱신되어 별도 갱신 호출 없이도 동일한 정보를 확보할 수 있으며, QMK `matrix info` CLI가 스캔 속도·큐 상태 등 추가 지표를 제공합니다.【F:src/ap/modules/qmk/port/matrix.c†L101-L144】
- **결론**: DMA 기반 구조에서는 `keys` CLI가 중복 기능만 제공해 유지 비용 대비 이점이 부족하므로 삭제하고, 필드 진단은 QMK 레이어 도구로 대체합니다.【F:src/hw/driver/keys.c†L36-L330】
