# RGB 인디케이터/동적 RGB 정지 회고 (V251116R1~V251121R1)

## 문제 및 증상
- CAPS ON 시 인디케이터 오버레이가 Snake6 같은 동적 RGB에 덮여 즉시 복귀하거나, CAPS 토글 후 LED가 정지·교착되는 문제가 반복 발생했다.
- `rgblight log on`일 때는 재현이 줄어드는 등 DMA가 아닌 스케줄링/타이밍 결함 가능성이 높았다.

## 커밋별 변화 요약
- ecc568d5a41ed87b070f1bfda119fc6e9ebffe68 (V251116R1): WS2812 DMA/CPU 더블 버퍼 도입으로 전송 중 버퍼 덮어쓰기를 제거했으나, CAPS 토글 정지 현상은 지속됐다.
- e7c39811a2731de8f6e389f4e5932950f1e27e8d (V251120R1): INDICATOR_ENABLE 가드 추가, CAPS OFF 즉시 기본 프레임 큐잉, 인디케이터 활성 중에도 베이스 이펙트 타이머를 계속 돌려 렌더 루프가 멈추지 않게 스케줄러를 재정렬했다.
- V251121R1: 인디케이터가 `overrides_all`일 때도 매 렌더마다 최종 오버레이를 강제 적용해 동적/정적 RGB가 녹색 오버레이를 덮지 못하도록 고정했다.

## 시행착오에서 얻은 결론
- DMA Busy/Timeout/카운터는 정상이고 더블 버퍼 도입 후에도 정지가 재현되어, 근본 원인은 DMA 전송이 아니라 렌더 요청·우선순위 소거에 있었다.
- `rgblight_timer_task()`가 오버레이 활성 시 베이스 애니메이션을 멈추게 해 렌더 큐가 비고, CAPS OFF 때만 다시 살아나는 패턴이 반복됐다.
- `rgblight_render_frame()`에서 `overrides_all`+`needs_render=false` 조건으로 오버레이 적용을 생략해, 인디케이터 ON 직후에도 베이스 프레임이 최종 출력으로 남을 수 있었다.

## 최종 원인 정리
- **스케줄러 우선순위 설계 결함**: 인디케이터 전체 오버레이 시 타이머를 조기 종료하고 렌더 요청을 소거해 베이스 이펙트가 큐에 오르지 못했고, 로깅 on/off 타이밍에 따라 정지/교착이 달라졌다.
- **오버레이 적용 누락**: 전체 오버레이임에도 `needs_render`가 false일 때 오버레이를 건너뛰어 인디케이터가 RGB 효과를 덮지 못했다. 이로 인해 CAPS ON→녹색 점등 후 곧바로 Snake6로 복귀하는 현상이 발생했다.

## 개선 후 상태
- V251120R1+V251121R1 적용으로 인디케이터 활성 중에도 베이스 이펙트가 정상 주기로 렌더되며, 최종 출력 단계에서 항상 인디케이터가 덮어씌워져 CAPS ON 시 녹색 오버레이가 유지된다.
- CAPS OFF 시 기본 프레임을 즉시 재큐잉해 잔상/정지 없이 복귀한다.

## 후속 점검 포인트
- HID 이벤트와 애니메이션 타이머가 동시에 렌더를 요청할 때 플래그 증감(`render_pending/needs_render`)이 과도 또는 소거되지 않는지 로깅으로 확인.
- 로깅 on/off 환경, CAPS 토글 반복, Snake6 등 동적 효과에서 큐 폭증/스톨이 없는지 실측 지속.***
